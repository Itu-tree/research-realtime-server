---
title: "MagicOnion + MessagePack + YetAnotherHttpHandler ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã‚’è¡Œã†"
emoji: "ğŸ•Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["MagicOnion","MessagePack","YetAnotherHttpHandler","ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ¼ãƒãƒ¼","Unity"]
published: true
---

# æ¦‚è¦

2024å¹´æœ€æ–°ç‰ˆã® MagicOnion 6.0.1 + MessagePack 2.5.140 + YetAnotherHttpHandler 1.0.0 ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã‚’è¡Œã†ç’°å¢ƒæ§‹ç¯‰æ‰‹é †ã‚’æ›¸ãã¾ã—ãŸã€‚ã¾ãŸã€Unityã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ IL2CPP ãƒ“ãƒ«ãƒ‰ã¾ã§è¡Œã„ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ¼ãƒãƒ¼ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦èµ·å‹•ã™ã‚‹ã¨ã“ã‚ã¾ã§è¡Œã„ã¾ã™ã€‚


è¨˜äº‹ã‚’æ›¸ããã£ã‹ã‘ã¨ãªã£ãŸã®ã¯ã€Cysharp ã•ã‚“ã‹ã‚‰ grpc-dotnet ãŒåˆ©ç”¨ã§ãã‚‹ [YetAnotherHttpHandler](https://github.com/Cysharp/YetAnotherHttpHandler) ã®å…¬é–‹ã§ã™ã€‚æœ€è¿‘ã¾ã§ã€Unityã§ gRPC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ã†éš›ã«ã¯ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã® C-Core gRPC ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã—ã‹ãªã„çŠ¶æ³ã§ã—ãŸãŒã€ YetAnotherHttpHandler ã¯ãã®å•é¡Œã‚’è§£æ±ºã—ã¾ã™ã€‚Unity ã® gRPC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆäº‹æƒ…ã«ã¤ã„ã¦ã¯ã“ã¡ã‚‰ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚[ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æœŸé–“ãŒå°‘ãªãã¨ã‚‚2024å¹´10æœˆã¾ã§å†å»¶æœŸ | gRPC](https://grpc.io/blog/grpc-csharp-future/), [neue cc - Unityç”¨ã®HTTP/2(gRPC) Clientã€YetAnotherHttpHandlerã‚’å…¬é–‹ã—ã¾ã—ãŸ](https://neue.cc/2023/07/28_yetanotherhttphandler.html), [Unityã§ã‚‚grpc-dotnetã‚’ä½¿ã£ãŸgRPCãŒã—ãŸã„ - Activ8 Tech Blog](https://synamon.hatenablog.com/entry/grpc-dotnet-unity)


ã“ã®è¨˜äº‹ã®ç›®æ¨™ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæˆæœç‰©ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã™ã€‚
@[tweet](https://x.com/__tou__tou/status/1743201497654173782?s=20)


ã¾ãŸã€ã“ã®è¨˜äº‹ã§ã¯ Server ã® TLS åŒ–ã‚„ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ã§ã¯ã‚„ã‚Šã¾ã›ã‚“ã€‚ï¼ˆéœ€è¦ãŒã‚ã‚Šãã†ãªã‚‰ç¶šç·¨æ›¸ããï¼ã¨ã„ã†æ°—æŒã¡ã§ã™ï¼‰

è¿½è¨˜ï¼š æœ¬è¨˜äº‹ã¯ã€ã‚‚ã¨ã‚‚ã¨ MagicOnion 5.1.8 ã¨ YetAnotherHttpHandler 0.1.0 ã§ã®ç’°å¢ƒæ§‹ç¯‰ã®éš›ã®èº“ããƒã‚¤ãƒ³ãƒˆã‚’ç´¹ä»‹ã™ã‚‹è¨˜äº‹ã§ã—ãŸã€‚MagicOnion 6.0.1 ã¨ YetAnotherHttpHandler 1.0.0 ã®ãƒªãƒªãƒ¼ã‚¹ã«ã‚ˆã‚Šã€README ãŒæ›´æ–°ã•ã‚Œç’°å¢ƒæ§‹ç¯‰ãŒã—ã‚„ã™ããªã‚Šã¾ã—ãŸã€‚ãã®ãŸã‚æœ¬è¨˜äº‹ãŒãªãã¨ã‚‚ [MagicOnion README](https://github.com/Cysharp/MagicOnion) ã‚„ [å…¬å¼ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰](https://github.com/Cysharp/MagicOnion/tree/main/samples/ChatApp)ã€[YetAnotherHttpHandler README](https://github.com/Cysharp/YetAnotherHttpHandler)ã‚’èª­ã‚€ã ã‘ã§ã‚‚ååˆ†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

# ç’°å¢ƒ
- [.NET 8 ](https://learn.microsoft.com/ja-jp/dotnet/core/whats-new/dotnet-8?WT.mc_id=dotnet-35129-website)
  - .NET 7 ä»¥é™ã§ Linux ä¸Šã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚„ gRPC ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä¸ŠãŒã£ãŸã‚‰ã—ãã€LTS ç‰ˆã® .NET8 ã‚’ä½¿ã„ã¾ã™
- Unity2022.3.14f1
  - ã“ã‚Œã‚ˆã‚Šæ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚ã‚Œã°å¤§ä¸ˆå¤«ãªã¯ãš
- [MagicOnion 6.0.1 | GitHub ](https://github.com/Cysharp/MagicOnion)
  - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ¼ãƒãƒ¼ç”¨é€”ã¨ã—ã¦åˆ©ç”¨ã§ãã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- [MessagePack-CSharp 2.5.140 | GitHub ](https://github.com/MessagePack-CSharp/MessagePack-CSharp)
  - C#ç”¨ã®é«˜é€Ÿãªã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶
- [YetAnotherHttpHandler 1.0.0 | GitHub](https://github.com/Cysharp/YetAnotherHttpHandler) 
  - Unity ã§ä½¿ãˆã‚‹ gRPC, HTTP/2 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
  - grpc-dotnet ã¨ã®äº’æ›æ€§ãŒã‚ã‚‹
  - å†…éƒ¨å®Ÿè£…ãŒ Rust 

# ã‚µãƒ³ãƒ—ãƒ«ç”¨ GitHub ãƒªãƒã‚¸ãƒˆãƒª

ä»¥ä¸‹ã«æœ¬è¨˜äº‹ã§ç´¹ä»‹ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ãƒªãƒã‚¸ãƒˆãƒªã‚’ç½®ã„ã¦ãŠãã¾ã™ã€‚è¨˜äº‹ã®èª¬æ˜ãŒä¸ååˆ†ã ã£ãŸã‚Šã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

- [tou-tou/magiconion-sample-server](https://github.com/tou-tou/magiconion-sample-server)
- [tou-tou/magiconion-sample-client](https://github.com/tou-tou/magiconion-sample-client)

# MagicOnion Server ç·¨
å¤§ã¾ã‹ã«ã€MagicOnion Server ç·¨ã€Unityã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç·¨ã¨åˆ†ã‘ã¦æ‰‹é †ã‚’è¨˜è¿°ã—ã¦ã„ã¾ã™ã€‚ã¾ãšã¯ MagicOnion Server ç·¨ã§ã™ã€‚


## äº‹å‰æº–å‚™
- .NET SDK8.0 ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  - [.NET 8.0 (Linuxã€macOSã€Windows) ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹](https://dotnet.microsoft.com/ja-jp/download/dotnet/8.0)
- IDE ã®æ›´æ–°
  - .NET8 å¯¾å¿œã®ãŸã‚ã« Visual Studio ã‚„ Rider ã®æœ€æ–°ç‰ˆã¸ã®æ›´æ–°ãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚


## æœ€åˆã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼æ§‹æˆ

```
magiconion-sample-server
â”œâ”€â”€ .git
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md

```

## ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ

.NET ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã¨2ã¤ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã«2ã¤ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚
2ã¤ã®ãƒ—ãƒ«ã‚¸ã‚§ã‚¯ãƒˆã®ã†ã¡ã€1ã¤ã¯ Server ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ MagicOnion Server ã®å®Ÿè£…ã‚’ç½®ããƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚2ã¤ã‚ã¯ Server ã¨ Unityã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å…±æœ‰ã™ã‚‹ Shared ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã€Interfaceç¾¤ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚Server ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå´ã§ã“ã® Interface ã‚’å®Ÿè£…ã—ã€Unity ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã¯ã“ã® Interface ã‚’åˆ©ç”¨ã™ã‚‹é–¢ä¿‚ã«ãªã‚Šã¾ã™ã€‚

```shell:powershell
> cd magiconion-sample-server
> dotnet new sln -n magiconion-sample-server
> dotnet new console -n Server -o magiconion-sample-server --framework net8.0
> dotnet sln magiconion-sample-server.sln add Server/Server.csproj
> dotnet new classlib -n Shared -o magiconion-sample-server
> dotnet sln magiconion-sample-server.sln add Shared/Shared.csproj
```


ã¾ãŸã€Server ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯æœ€æ–°ã® .NET 8 ã‚’æŒ‡å®šã—ã¾ã™ã€‚.NET 7 ä»¥é™ã§ Linux ä¸Šã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚„ gRPC ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä¸ŠãŒã£ãŸã‚‰ã—ãã€LTS ç‰ˆã® .NET8 ã‚’ä½¿ã„ã¾ã™ã€‚


`magiconion-sample-server.sln`ã‚’Explorererã‹ã‚‰ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ãªã‚Šã—ã¦é–‹ãã¾ã™

ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã«ãªã£ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

```
magiconion-sample-server
â”œâ”€â”€ .git
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md
â”œâ”€â”€ Server
â”‚   â”œâ”€â”€ Program.cs
â”‚   â””â”€â”€ Server.csproj
â”œâ”€â”€ Shared
â”‚   â”œâ”€â”€ Class1.cs
â”‚   â””â”€â”€ Shared.csproj
â””â”€â”€ magiconion-sample-server.sln

```

ã¾ãŸã€Shared ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ã¯ .NET8 ç’°å¢ƒã€Unity ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã¯ Unity2022.3.14f1 ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ç’°å¢ƒï¼ˆC#9.0 ã¾ã§å¯¾å¿œï¼‰ã§å®Ÿè¡Œã•ã‚Œã‚‹ã®ã§ã€C#9.0 ã®æ§‹æ–‡ã§æ›¸ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚(ãŸã ã—ã€Shared.csproj ã§ `<LangVersion>9.0</LangVersion>` ã‚’æŒ‡å®šã™ã‚‹ã¨ Server ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ“ãƒ«ãƒ‰ã§ããªã„ã®ã§æ³¨æ„)


## Shared ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç”¨æ„
ã¾ãšã€Shared ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ Interface ã‚’å®šç¾©ã—ã¾ã™ã€‚Shared ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å®šç¾©ã—ãŸ Interface ã¯ Server ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å®Ÿè£…ã•ã‚Œã€Unityã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰åˆ©ç”¨ã•ã‚Œã‚‹é–¢ä¿‚ã«ãªã‚Šã¾ã™ã€‚

ã¾ãšã¯ `Shared.csproj`ã«å¿…è¦ãªä»¥ä¸‹ã® package ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings> 
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="MagicOnion.Abstractions" Version="6.0.0" />
    <PackageReference Include="MessagePack.Annotations" Version="2.5.140" />
    <PackageReference Include="MessagePack.UnityShims" Version="2.5.140" />
  </ItemGroup>

</Project>
```

### Shared ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ Interface ã®å®šç¾©
MagicOnion ã® [README](https://github.com/Cysharp/MagicOnion?tab=readme-ov-file#quick-start) ã‚’å‚è€ƒã«`Interface`ã‚’å®šç¾©ã—ã¾ã™ã€‚Shared ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«`Interfaces`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãã®é…ä¸‹ã«ä»¥ä¸‹ã® `IMyFirstService.cs`ã¨`IGamingHub.cs`ã‚’è¿½åŠ ã—ã¾ã™ã€‚


```cs:IMyFirstService
using MagicOnion;
namespace Shared.Interfaces
{
    public interface IMyFirstService : IService<IMyFirstService>
    {
        UnaryResult<int> SumAsync(int x, int y);
    }
}
```

```cs:IGamingHub
using System.Threading.Tasks;
using MagicOnion;
using MessagePack;
using UnityEngine;

namespace Shared.Interfaces
{
    public interface IGamingHubReceiver
    {
        void OnJoin(Player player);
        void OnLeave(Player player);
        void OnMove(Player player);
    }
    
    public interface IGamingHub : IStreamingHub<IGamingHub, IGamingHubReceiver>
    {
        ValueTask<Player[]> JoinAsync(string roomName, string userName, Vector3 position, Quaternion rotation);
        ValueTask LeaveAsync();
        ValueTask MoveAsync(Vector3 position, Quaternion rotation);
    }
    
    [MessagePackObject]
    public class Player
    {
        [Key(0)]
        public string Name { get; set; }
        [Key(1)]
        public Vector3 Position { get; set; }
        [Key(2)]
        public Quaternion Rotation { get; set; }
    }
}
```

### PackageåŒ–
æ¬¡ã«ã€Unity ã«ãŠã„ã¦ Shared ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ package ã¨ã—ã¦èªè­˜ã§ãã‚‹ã‚ˆã†ã«ã€Shared ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« `package.json` ã‚’è¿½åŠ ã—ã¾ã™ã€‚


```json:package.json
{
  "name": "com.magiconion-sample-server.shared",
  "version": "0.0.1",
  "displayName": "magiconion-sample-server shared"
}
```


ã•ã‚‰ã«ä¸è¦ãªClass1.csã¯å‰Šé™¤ã™ã‚‹ã¨ã€Shared ä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã¯ãšã§ã™ã€‚

```
Shared
â”œâ”€â”€ Interfaces
â”‚   â”œâ”€â”€ IGamingHub.cs
â”‚   â””â”€â”€ IMyFirstService.cs
â”œâ”€â”€ Shared.csproj
â””â”€â”€ package.json
```


## Server ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç”¨æ„

ç¶šã„ã¦ Server ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç”¨æ„ã‚’ã—ã¦ãã¾ã™ã€‚
ã¾ãš MagicOnion.Server 6.0.0 ã¨ Shared ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚

```csproj:Server.csproj
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="MagicOnion.Server" Version="6.0.0"/>
    <ProjectReference Include="../Shared/Shared.csproj"/>
  </ItemGroup>

</Project>

```

### Server ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ Interface ã®å®Ÿè£…

MagicOnion ã® [README](https://github.com/Cysharp/MagicOnion#service-implementation-server-side) ã®é€šã‚Š`MyFistService.cs`ã¨`GamingHub.cs`ã¨ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚
ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```bash
Server
â”œâ”€â”€ Program.cs
â”œâ”€â”€ Server.csproj
â”œâ”€â”€ Services
â”‚Â Â  â””â”€â”€ MyFirstService.cs
â””â”€â”€â”€ StreamingHub
   â””â”€â”€ GamingHub.cs

```
```cs:MyFirstService.cs
using MagicOnion;
using MagicOnion.Server;
using Shared.Interfaces;

namespace Server.Services;

// copied from https://github.com/Cysharp/MagicOnion#service-implementation-server-side
// Implements RPC service in the server project.
// The implementation class must inherit `ServiceBase<IMyFirstService>` and `IMyFirstService`
public class MyFirstService : ServiceBase<IMyFirstService>, IMyFirstService
{
    // `UnaryResult<T>` allows the method to be treated as `async` method.
    public async UnaryResult<int> SumAsync(int x, int y)
    {
        Console.WriteLine($"Received:{x}, {y}");
        return x + y;
    }
}

```

```cs:GamingHub.cs
using MagicOnion.Server.Hubs;
using Shared.Interfaces;
using UnityEngine;

namespace Server.StreamingHub;

// copied from https://github.com/Cysharp/MagicOnion#streaminghub
// Server implementation
// implements : StreamingHubBase<THub, TReceiver>, THub
public class GamingHub : StreamingHubBase<IGamingHub, IGamingHubReceiver>, IGamingHub
{
    // this class is instantiated per connected so fields are cache area of connection.
    IGroup room;
    Player self;
    IInMemoryStorage<Player> storage;

    public async ValueTask<Player[]> JoinAsync(string roomName, string userName, Vector3 position, Quaternion rotation)
    {
        self = new Player() { Name = userName, Position = position, Rotation = rotation };

        // Group can bundle many connections and it has inmemory-storage so add any type per group.
        (room, storage) = await Group.AddAsync(roomName, self);

        // Typed Server->Client broadcast.
        Broadcast(room).OnJoin(self);

        return storage.AllValues.ToArray();
    }

    public async ValueTask LeaveAsync()
    {
        await room.RemoveAsync(this.Context);
        Broadcast(room).OnLeave(self);
    }

    public async ValueTask MoveAsync(Vector3 position, Quaternion rotation)
    {
        self.Position = position;
        self.Rotation = rotation;
        Console.WriteLine($"MoveAsync: {self.Name} pos:{position.x} {position.y} {position.z} rot:{rotation.x} {rotation.y} {rotation.z} {rotation.w}");
        Broadcast(room).OnMove(self);
    }

    // You can hook OnConnecting/OnDisconnected by override.
    protected override ValueTask OnDisconnected()
    {
        // on disconnecting, if automatically removed this connection from group.
        return ValueTask.CompletedTask;
    }
}
``` 

### ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã®å®Ÿè£…
ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¨ã¨ã—ã¦`Program.cs`ã®ä¸­èº«ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚

```cs:Program.cs
using System.Net;
using System.Security.Cryptography.X509Certificates;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Server.Kestrel.Core;
using Microsoft.Extensions.DependencyInjection;

namespace Server;

internal static class Program
{
    public static void Main(string[] args)
    {
        var builder = WebApplication.CreateBuilder(args);
        
        builder.WebHost.UseKestrel(options =>
        {
            options.ConfigureEndpointDefaults(endpointOptions =>
            {
                endpointOptions.Protocols = HttpProtocols.Http2;
            });
            
            // HTTP/1.1ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è¨­å®š
            options.Listen(IPAddress.Parse("0.0.0.0"), 5000, listenOptions =>
            {
                listenOptions.Protocols = HttpProtocols.Http1;
            });
            
            // HTTP/2 ,HTTPS ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è¨­å®š
            options.Listen(IPAddress.Parse("0.0.0.0"), 5001, listenOptions =>
            {
                // --load-cert=true ãŒæŒ‡å®šã•ã‚Œã¦ã„ãŸã‚‰è¨¼æ˜æ›¸ã‚’èª­ã¿è¾¼ã‚€
                if (args.Any(arg => arg == "--load-cert=true"))
                {
                    Console.WriteLine("load certificate");
                    listenOptions.UseHttps(new X509Certificate2("certificate/certificate.pfx","test"));
                }
            });
        });
        
        builder.Services.AddGrpc();
        builder.Services.AddMagicOnion();

        var app = builder.Build();
        
        // ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
        app.MapGet("/", () => "Hello World!");
        
        // MagicOnionã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
        app.MapMagicOnionService();

        app.Run();
    }
}

```


ä»¥ä¸‹ã®ç‚¹ã‚’è€ƒæ…®ã—ã¦ã„ã¾ã™ã€‚
- å•é¡Œã®åˆ‡ã‚Šåˆ†ã‘ç”¨ã« HTTP/1.1 ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç”¨æ„ã—ã¦ãŠã
- ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®IPã¯ `0.0.0.0`ã«ã—ã¦ã„ã‚‹ã®ã¯ã€docker ã‚³ãƒ³ãƒ†ãƒŠä¸Šã§ Server ã‚’èµ·å‹•ã—ãŸã¨ãã«ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ¥½ã«ã™ã‚‹ãŸã‚
  - ãªã®ã§ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹å ´åˆã¯`127.0.0.1`ã§ã‚‚å¤§ä¸ˆå¤«
- è¨¼æ˜æ›¸ã‚’èª­ã¿è¾¼ã‚€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ãŒã€ç¾æ™‚ç‚¹ã§ã¯è¨¼æ˜æ›¸ã‚’ç”Ÿæˆã—ã¦ã„ãªã„ã®ã§æ©Ÿèƒ½ã—ãªã„ã§ã™ã€‚


æœ€å¾Œã«é©å½“ãª GitHub ãƒªãƒã‚¸ãƒˆãƒªã« push ã—ã¦ãŠãã¾ã™ã€‚
```
git push origin main
```


# Unity ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç·¨

## äº‹å‰æº–å‚™
- ï¼ˆå¿…è¦ãªäººã¯ï¼‰C++ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¨ Windows SDK ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  - ä¾‹ãˆã°ã€Visual Studio Installer ã‚’èµ·å‹•ã—ã¦ å¤‰æ›´ -> C++ ã«ã‚ˆã‚‹ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é–‹ç™º ã‚’é¸æŠã—ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
  - IL2CPP ãƒ“ãƒ«ãƒ‰ã§å¿…è¦ã«ãªã‚Šã¾ã™ã€‚
- UnityHub ã‹ã‚‰é©å½“ãª Unity ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
  - ç§ã¯ Unity2022.3.14f1 & URP 3Dãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã—ã¾ã—ãŸã€‚
- .gitignore, .gitattributeã‚’è¿½åŠ 
  - [magiconion-sample-client/.gitignore](https://github.com/tou-tou/magiconion-sample-client/blob/main/.gitignore)
  - [magiconion-sample-client/.gitattributes](https://github.com/tou-tou/magiconion-sample-client/blob/main/.gitattributes)
- `git init`ã§ãƒ­ãƒ¼ã‚«ãƒ« git ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆ


## å¿…è¦ãª Unity Package ã‚’ openupm çµŒç”±ã§è¿½åŠ 

Packages ãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã«å­˜åœ¨ã—ã¦ã„ã‚‹`manifest.json`å†…ã®`scopedRegistries`ã¨ã—ã¦ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```json:manifest.json
"scopedRegistries": [
    {
      "name": "package.openupm.com",
      "url": "https://package.openupm.com",
      "scopes": [
        "com.cysharp.magiconion",
        "com.neuecc.messagepack",
        "com.cysharp.yetanotherhttphandler",
        "com.veriorpies.parrelsync"
      ]
    }
  ],
```


`dependencies`ã¨ã—ã¦ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```json:manfest.json
...
 "dependencies": {
    "com.cysharp.magiconion": "6.0.1",
    "com.neuecc.messagepack": "2.5.140",
    "com.cysharp.yetanotherhttphandler": "1.0.0",
    "com.github-glitchenzo.nugetforunity": "4.0.2",
    "com.veriorpies.parrelsync": "1.5.2",
    "com.magiconion-sample-server.shared": "file:../../magiconion-sample-client/magiconion-sample-server/Shared/",
...
 }
```

è¿½åŠ ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

https://github.com/tou-tou/magiconion-sample-client/blob/main/Packages/manifest.json


è¿½åŠ ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã¤ã„ã¦
- [ParrelSync](https://github.com/VeriorPies/ParrelSync)ã¯ Unity Editor ã‚’è¤‡æ•°ç«‹ã¡ä¸Šã’ã¦ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ã®ãƒ‡ãƒãƒƒã‚°ãŒã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
- Shared ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã« `"com.magiconion-sample-server.shared": "file:../../magiconion-sample-client/magiconion-sample-server/Shared/",`ã¨æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
  - `"file:../../magiconion-sample-client/magiconion-sample-server/Shared/"`ã«æ–¼ã„ã¦ã€`../../`ã§2ã¤ä¸Šã®è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã®ã¯ ParrelSync ã‚’æ­£å¸¸ã«å‹•ã‹ã™ãŸã‚ã§ã™ã€‚
- [NuGetForUnity: A NuGet Package Manager for Unity](https://github.com/GlitchEnzo/NuGetForUnity)
  - ã“ã‚Œã‚’ä½¿ã†ã¨ `.unitypacakge`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ import ã—ã¦ dll ã‚’èª­ã¿è¾¼ã‚€ã€ã‚’ã—ãªãã¦æ¸ˆã¿ã¾ã™ã€‚
  - ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚‚ã—ã¦ãã‚Œã‚‹ã®ã§æ›´æ–°ãŒæ¥½ã«ãªã‚Šã¾ã™ã€‚


## å¿…è¦ãª NuGet Pacakge ã‚’è¿½åŠ 

ã¾ãšã¯ã€ YetAnotherHttpHandler ã®[ä¾å­˜é–¢ä¿‚](https://github.com/Cysharp/YetAnotherHttpHandler/releases/tag/redist-20230728-01)ã‚’ NuGetForUnity çµŒç”±ã§è¿½åŠ ã—ã¾ã™ã€‚

ä¸Šè¨˜ã®å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ NuGetForUnity ã® GUI ã§ãƒãƒãƒãƒã¨è¿½åŠ ã™ã‚‹ã‹ `Assets/package.config` ã«ä»¥ä¸‹ã‚’è¨˜è¿°ã™ã‚‹ã‹ã‚’ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚

ã•ã‚‰ã« `MessagePack 2.5.140` ã¯`Microsoft.NET.StringTools >=17.6.3`ã«ä¾å­˜ã—ã¦ã„ã‚‹ã®ã§è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚
[NuGet Gallery | MessagePack 2.5.140](https://www.nuget.org/packages/messagepack/#dependencies-body-tab)

https://github.com/tou-tou/magiconion-sample-client/blob/ea4bdb16d0654e68ff63054817641ceb1ff22c0b/Assets/packages.config


## Shared ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã« AssemblyDefinition ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 

ã‚µãƒ¼ãƒãƒ¼å´ã§ã¯ csproj ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¾å­˜é–¢ä¿‚ã‚’è§£æ±ºã—ã¦ã„ã¾ã—ãŸãŒã€Unity å´ã§ã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¾å­˜é–¢ä¿‚ã®è§£æ±ºã®ãŸã‚ã« Assembly Definition ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

Unity Editor ã® Projetã‚¿ãƒ–ã‹ã‚‰`Packages/magiconion-sampler-server shared`ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ãã€ãã®é…ä¸‹ã« AssemblyDefinitions ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚ Assembly Deffinition References ã« `MessagePack.Annotations`ã¨`MagicOnion.Abstractions`ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€Shared ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å¿…è¦ãª MagicOnion ã‚„ MessagePack ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚

![Alt text](/images/asdf.png =500x)


ãã®å¾Œã€Submoduleã®magiconion-sample-serverãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆå®Ÿä½“ã¯ git ãƒ­ãƒ¼ã‚«ãƒ«ãƒªãƒã‚¸ãƒˆãƒªï¼‰å†…ã§å¤‰æ›´ã‚’ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã« push ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚ 
```bash:powershell
# path-to/magiconion-sample-client 
> cd magiconion-sample-server
> git status
Untracked files:
  (use "git add <file>..." to include in what will be committed)
        Shared/Shared.asmdef
> git add Shared/Shared.asmdef
> git commit -m "add asmdef"
> git push origin main

```

 
 ## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…
 ç¶šã„ã¦ã€[MagicOnionã®README](https://github.com/Cysharp/MagicOnion?tab=readme-ov-file#streaminghub)ã‚’å‚è€ƒã« Streming Hub ã®å®Ÿè£…ã‚’ã—ã¾ã™ã€‚

 ```cs:GamingHubClient.cs
using System.Collections.Generic;
using System.Threading.Tasks;
using Grpc.Core;
using MagicOnion.Client;
using Shared.Interfaces;
using UnityEngine;

namespace SampleClient
{
    public class GamingHubClient : IGamingHubReceiver
    {
        private Dictionary<string, GameObject> _players = new();

        private IGamingHub _client;

        private readonly GameObject _ownPlayer;

        public GamingHubClient(GameObject player)
        {
            _ownPlayer = player;
        }

        public async ValueTask<GameObject> ConnectAsync(ChannelBase grpcChannel, string roomName, string playerName)
        {
            _client = await StreamingHubClient.ConnectAsync<IGamingHub, IGamingHubReceiver>(grpcChannel, this);

            var roomPlayers = await _client.JoinAsync(roomName, playerName, Vector3.zero, Quaternion.identity);
            foreach (var player in roomPlayers) (this as IGamingHubReceiver).OnJoin(player);

            return _players[playerName];
        }

        // methods send to server.

        public ValueTask LeaveAsync(string playerName)
        {
            foreach (var cube in _players)
                if (cube.Value.name != playerName)
                    Object.Destroy(cube.Value);

            return _client.LeaveAsync();
        }

        public ValueTask MoveAsync(Vector3 position, Quaternion rotation)
        {
            // ãŸã¾ã«nullã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€nullãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹
            if (_client == null) return new ValueTask();
            return _client.MoveAsync(position, rotation);
        }

        // dispose client-connection before channel.ShutDownAsync is important!
        public Task DisposeAsync()
        {
            return _client.DisposeAsync();
        }

        // You can watch connection state, use this for retry etc.
        public Task WaitForDisconnect()
        {
            return _client.WaitForDisconnect();
        }

        // Receivers of message from server.

        void IGamingHubReceiver.OnJoin(Player player)
        {
            Debug.Log("Join Player:" + player.Name);

            // è‡ªåˆ†ã®å ´åˆã¯è‡ªåˆ†ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ãªã„
            if (_ownPlayer.name == player.Name)
            {
                _players[player.Name] = _ownPlayer;
            }
            else
            {
                var playerObject = GameObject.CreatePrimitive(PrimitiveType.Cube);
                var LitMat = Resources.Load<Material>("LitMat");
                playerObject.GetComponent<Renderer>().material = LitMat;
                playerObject.name = player.Name;
                playerObject.transform.SetPositionAndRotation(player.Position, player.Rotation);
                _players[player.Name] = playerObject;
            }
        }

        void IGamingHubReceiver.OnLeave(Player player)
        {
            Debug.Log("Leave Player:" + player.Name);

            if (_players.TryGetValue(player.Name, out var cube)) Object.Destroy(cube);
        }

        void IGamingHubReceiver.OnMove(Player player)
        {
            Debug.Log("Move Player:" + player.Name);

            if (_players.TryGetValue(player.Name, out var cube))
            {
                if (player.Name == _ownPlayer.name) return;
                cube.transform.SetPositionAndRotation(player.Position, player.Rotation);
            }
        }
    }
}
 ```


### Cube ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®è¿½åŠ 
ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ã§ Cube ã‚’æ“ä½œã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚


```cs:Controller.cs
using UnityEngine;

namespace SampleClient
{
    public class Controller : MonoBehaviour
    {
        public float moveSpeed = 5.0f;

        void Update()
        {
            if (Input.GetKey(KeyCode.W))
            {
                transform.Translate(Vector3.forward * (moveSpeed * Time.deltaTime));
            }
            if (Input.GetKey(KeyCode.S))
            {
                transform.Translate(Vector3.back * (moveSpeed * Time.deltaTime));
            }

            if (Input.GetKey(KeyCode.A))
            {
                transform.Translate(Vector3.left * (moveSpeed * Time.deltaTime));
            }
            if (Input.GetKey(KeyCode.D))
            {
                transform.Translate(Vector3.right * (moveSpeed * Time.deltaTime));
            }

            if (Input.GetKey(KeyCode.Q))
            {
                transform.Translate(Vector3.up * (moveSpeed * Time.deltaTime));
            }
            if (Input.GetKey(KeyCode.Z))
            {
                transform.Translate(Vector3.down * (moveSpeed * Time.deltaTime));
            }
        }
    }
}
```

ä¸‹å›³ã®ã‚ˆã†ã«ã‚·ãƒ¼ãƒ³ä¸Šã« Cube ï¼ˆä¾‹ãˆã°åå‰ã¯ user1 ï¼‰ã‚’ç”Ÿæˆã—ã€user1 ã«ä¸Šè¨˜ã®`Controller.cs`ã‚’ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™ã€‚

![Alt text](/images/user1.png)


 ### UI Tool Kitã§ UI ã®è¿½åŠ 
[ UI ToolKit ã‚’å°å…¥ã—ã¦åŠ¹ç‡ã‚ˆã UI ã‚’æ§‹ç¯‰ã™ã‚‹ ](https://forpro.unity3d.jp/unity_pro_tips/2022/04/21/3629/)ã‚’ãƒ™ãƒ¼ã‚¹ã«ç°¡å˜ãª UI ã‚’ä½œã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ä¸‹å›³ã®ã‚ˆã†ãª UI ã‚’ä½œæˆã—ã¾ã™ã€‚
![Alt text](/images/UIToolKit.png)


ä¸Šè¨˜ã® UI ã®å„ãƒœã‚¿ãƒ³ã¨æ©Ÿèƒ½ã‚’é€£æºã•ã›ã€ã¨ã‚Šã‚ãˆãšå‹•ãã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã™ã€‚
ï¼ˆ UI ã¨æ©Ÿèƒ½ãŒåˆ†é›¢ã—ã¦ãªã„ã¨ã‹ã€Dispose å‡¦ç†æ€ªã—ããªã„ã‹ã¨ã‹ã‚ã‚Šã¾ã™ãŒã€ã¨ã‚Šã‚ãˆãšå‹•ãã¾ã™...ï¼‰

```cs:SampleUIClient.cs
using System;
using Cysharp.Net.Http;
using Grpc.Core;
using Shared.Interfaces;
using Grpc.Net.Client;
using MagicOnion;
using MagicOnion.Client;
using UnityEngine;
using UnityEngine.UIElements;

namespace SampleClient
{
    public class SampleUIClient : MonoBehaviour
    {
        [SerializeField] private GameObject playerObject;
        private GamingHubClient _hubClient;
        private ChannelBase _channel;

        private TextField nameField;
        private TextField roomField;
        private bool _isConnected = false;

        private async void Start()
        {
            _channel = GrpcChannelx.ForAddress("http://127.0.0.1:5001/");

            var serviceClient = MagicOnionClient.Create<IMyFirstService>(_channel);
            var result = await serviceClient.SumAsync(100, 200);
            Debug.Log(result);

            // UIãƒœã‚¿ãƒ³ã¨æ©Ÿèƒ½ã®é€£æº
            var root = GetComponent<UIDocument>().rootVisualElement;
            var button = root.Q<Button>("Connect");
            button.clicked += async () =>
            {
                Debug.Log("room Button clicked!");
                if (_isConnected) return;
                _hubClient = new GamingHubClient(playerObject);
                _ = await _hubClient.ConnectAsync(_channel, roomField.value, nameField.value);
                _isConnected = true;
                nameField.isReadOnly = true;
                nameField.isReadOnly = true;
            };

            var button2 = root.Q<Button>("Disconnect");
            button2.clicked += async () =>
            {
                Debug.Log("name Button clicked!");
                _isConnected = false;
                nameField.isReadOnly = false;
                nameField.isReadOnly = false;
                await _hubClient.LeaveAsync(playerObject.name);
                await _hubClient.DisposeAsync();
            };

            nameField = root.Q<TextField>("name");
            playerObject.name = nameField.value;
            nameField.RegisterValueChangedCallback(evt =>
            {
                Debug.Log("Entered Name: " + evt.newValue);
                if (!_isConnected) playerObject.name = evt.newValue;
            });

            roomField = root.Q<TextField>("room");
            roomField.RegisterValueChangedCallback(evt =>
            {
                Debug.Log("Entered Name: " + evt.newValue);
                if (_isConnected) roomField.isReadOnly = true;
            });
        }

        private async void Update()
        {
            if (_hubClient == null) return;
            if (_isConnected)
            {
                var position = playerObject.transform.position;
                var rotation = playerObject.transform.rotation;
                await _hubClient.MoveAsync(position, rotation);
            }
        }

        private async void OnApplicationQuit()
        {
            if (_hubClient == null) return;
            await _hubClient.LeaveAsync(playerObject.name);
            await _hubClient.DisposeAsync();
        }
    }
}
```

ã‚·ãƒ¼ãƒ³ä¸Šã«å­˜åœ¨ã™ã‚‹UI Document ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸ GameObjectï¼ˆä¸‹å›³ã®å ´åˆã ã¨ UIClientï¼‰ã«ä¸Šè¨˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚¢ã‚¿ãƒƒãƒã—ã€å…ˆã»ã©ä½œæˆã—ãŸ user1 ã‚’ Player Object ã«å‰²ã‚Šå½“ã¦ã¾ã™ã€‚

![Alt text](/images/UIClient.png)


## IL2CPP å‘ã‘ã®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ

IL2CPP ã¯ã€ãƒ“ãƒ«ãƒ‰æ™‚ã« Unity ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã® C# ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸä¸­é–“è¨€èªã‚³ãƒ¼ãƒ‰ã‚’ C++ ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›ã—ã€ãã®å¾Œãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ¼ãƒ‰ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦å®Ÿè¡Œå¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚

ã¾ãŸã€é€šä¿¡éƒ¨åˆ†ï¼ˆMagicOnionï¼‰ã‚„ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºéƒ¨åˆ†ï¼ˆMessagePackï¼‰ã§ã¯ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã®ä¸€éƒ¨ï¼ˆã“ã“ã§ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‹æƒ…å ±ã‚’åˆ©ç”¨ã—ã¦åŠ¹ç‡ã®è‰¯ã„ã‚³ãƒ¼ãƒ‰ã‚’å‹•çš„ç”Ÿæˆã™ã‚‹ã‚ˆã†ãªä»•çµ„ã¿ï¼‰ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå¤šã„ã®ã§ã™ãŒã€IL2CPP ã§ã¯å®Ÿè¡Œæ™‚ã®å‹•çš„ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã¯ç¦æ­¢ã•ã‚Œã¦ãŠã‚Šã€å‹•çš„ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«ä¾å­˜ã™ã‚‹ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã¯åˆ¶é™ã•ã‚Œã¾ã™ã€‚

ãã®ãŸã‚ã€IL2CPP ã§ã¯å‹•çš„ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«ä¾å­˜ã™ã‚‹ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã®ãŸã‚ã«å¿…è¦ãªå…¨ã¦ã®ã‚³ãƒ¼ãƒ‰ã‚’äº‹å‰ã«ç”Ÿæˆã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚


ä¸Šè¨˜ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€MessagePack ã§ã¯ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ„ãƒ¼ãƒ«ã€MagicOnion ã§ã¯ SourceGnerator ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã®ã§ãã‚Œã‚’åˆ©ç”¨ã—ã¾ã™ã€‚


### MessagePack for C# ç”¨ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
mpc (MessagePack Codegen)ã‚’ä½¿ã£ã¦ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’ã—ã¾ã™ã€‚ã“ã¡ã‚‰ã¯ Editoræ‹¡å¼µã¨ã—ã¦æä¾›ã•ã‚Œã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚’ä½¿ã„ã¾ã™ã€‚
[MessagePackã®README](https://github.com/MessagePack-CSharp/MessagePack-CSharp?tab=readme-ov-file#aot-code-generation-support-for-unityxamarin)ã‚’å‚è€ƒã«é€²ã‚ã¾ã™ã€‚
![Alt text](/images/messagepack.png)

ä¸Šè¨˜ã®ä¾‹ã ã¨`Assets/Scripts/Generated/Serializer.generated.cs`ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

### MagicOnion ç”¨ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ ã¨ Resolver ã®ç™»éŒ²

[MagicOnionã®README](https://github.com/Cysharp/MagicOnion?tab=readme-ov-file#ahead-of-time-compilation-support-with-source-generator)ã®é€šã‚Š Source Generator ã§ç”Ÿæˆã§ãã¾ã™ã€‚


ä¸Šè¨˜ã§ç”Ÿæˆã—ãŸã‚³ãƒ¼ãƒ‰ï¼ˆ`MessagePackSampleResolver.Instance`ã¨`MagicOnionClientInitializer.Resolver`ï¼‰ãŒå®Ÿè¡Œæ™‚ã« Static ãªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ç™»éŒ²ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®`Initializer.cs`ã‚’`Assets/Scripts/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«ä½œæˆã—ã¾ã™ã€‚

```cs:Initializer.cs
using Grpc.Net.Client;
using MagicOnion.Client;
using MagicOnion.Unity;
using MessagePack;
using MessagePack.Resolvers;
using UnityEngine;

namespace SampleClient
{
    // Shared ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ã®ã‚¢ã‚»ãƒ³ãƒ–ãƒªã«å«ã¾ã‚Œã¦ã„ã‚Œã°ã€`IMyFirstService` ã‹ `IGamingHub` ã®ã©ã¡ã‚‰ã®æŒ‡å®šã§ã‚‚OK
    [MagicOnionClientGeneration(typeof(Shared.Interfaces.IMyFirstService))]
    internal partial class MagicOnionClientInitializer
    {
    }

    public static class Initializer
    {
        [RuntimeInitializeOnLoadMethod(RuntimeInitializeLoadType.BeforeSceneLoad)]
        private static void RegisterResolvers()
        {
            // NOTE: Currently, CompositeResolver doesn't work on Unity IL2CPP build. Use StaticCompositeResolver instead of it.
            StaticCompositeResolver.Instance.Register(
                // This resolver is generated by MagicOnion's Source Generator.
                // See below for details. https://github.com/Cysharp/MagicOnion?tab=readme-ov-file#ahead-of-time-compilation-support-with-source-generator
                MagicOnionClientInitializer.Resolver,
                // This resolver is generated by MessagePack's code generator.
                MessagePackSampleResolver.Instance,
                BuiltinResolver.Instance,
                PrimitiveObjectResolver.Instance,
                MessagePack.Unity.UnityResolver.Instance,
                StandardResolver.Instance
            );

            MessagePackSerializer.DefaultOptions = MessagePackSerializer.DefaultOptions
                .WithResolver(StaticCompositeResolver.Instance);
        }

        [RuntimeInitializeOnLoadMethod(RuntimeInitializeLoadType.BeforeSceneLoad)]
        public static void OnRuntimeInitialize()
        {
            GrpcChannelProviderHost.Initialize(
                new GrpcNetClientGrpcChannelProvider(() => new GrpcChannelOptions()
                {
                    HttpHandler = new Cysharp.Net.Http.YetAnotherHttpHandler()
                    {
                        Http2Only = true
                    }
                }));
        }
    }
}
```

## ãƒãƒ†ãƒªã‚¢ãƒ«ã®è¨­å®š

ä¸‹å›³ã®ã‚ˆã†ã« `Assets/Rsources`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`LitMat`ã¨ã„ã†åã§ãƒãƒ†ãƒªã‚¢ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚Shader ã¯ `Universal Render Pipeline/Lit`ã¨ã—ã¦ã„ã¾ã™ã€‚user1 ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ãªã©ã—ã¦ user1 ã®ãƒãƒ†ãƒªã‚¢ãƒ«ã‚’ `LitMat` ã«å¤‰æ›´ã—ã¾ã™ã€‚

![Alt text](/images/resources.png)

ã“ã®ãƒãƒ†ãƒªã‚¢ãƒ«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«`GameObject.CreatePrimitive(PrimitiveType.Cube)` ã§ç”Ÿæˆã•ã‚Œã‚‹ Cube ã«ã‚¢ã‚¿ãƒƒãƒã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ãŸå ´åˆã€URP ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰ã§ã¯ãªãœã‹æœŸå¾…é€šã‚Šã®ãƒãƒ†ãƒªã‚¢ãƒ«ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚Œãªã„ãŸã‚ã§ã™ã€‚
https://github.com/tou-tou/magiconion-sample-client/blob/fcb15a62bb6fa35af178cd6c4eb42b74818df4d0/Assets/Scripts/GamingHubClient.cs#L75-L77

# IL2CPP ãƒ“ãƒ«ãƒ‰ã®è¨­å®š
æœ€å¾Œã« IL2CPP ãƒ“ãƒ«ãƒ‰ã®ãŸã‚ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

Unity Editor ã® File -> Build Settings -> Player Settings -> Player ã‹ã‚‰

Scripting Backend ã‚’ IL2CPP ã«
![Alt text](/images/ScriptingBackend.png)

ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚‚å‹•ãã‚ˆã†ã«
![Alt text](/images/RunInBackground.png)

ã‚¢ãƒ—ãƒªã®Windowã‚µã‚¤ã‚ºã‚’é©å½“ãªå¤§ãã•ã«
![Alt text](/images/WindowSize.png)


File -> Build Settings -> Build ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚

# å‹•ã‹ã™
magiconion-sample-server ã® Server ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ IDE ã‹ã‚‰ç›´æ¥å®Ÿè¡Œã™ã‚‹ãªã‚Šã€ãƒ“ãƒ«ãƒ‰ã—ã¦ã‹ã‚‰å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ãªã‚Šã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚
å…ˆã»ã©ç”Ÿæˆã—ãŸ Unity ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½•å›ã‹ã‚¯ãƒªãƒƒã‚¯ã—è¤‡æ•°ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’èµ·å‹•ã—ã¾ã™ã€‚

ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ã€‚
@[tweet](https://x.com/__tou__tou/status/1743201497654173782?s=20)



# ã‚±ãƒ¼ã‚¹åˆ¥ã‚¨ãƒ©ãƒ¼å¯¾å¿œ
:::details ã‚±ãƒ¼ã‚¹åˆ¥ã‚¨ãƒ©ãƒ¼å¯¾å¿œ

## Microsoft.NET.StringTools ãŒãªã„
```
Library\PackageCache\com.neuecc.messagepack@2.5.140\Formatters\StringInterningFormatter.cs(5,17): error CS0234: The type or namespace name 'NET' does not exist in the namespace 'Microsoft' (are you missing an assembly reference?)
```
`Microsoft.NET.StringTools` 17.6.3 ã‚’NuGetForUnityã‹ã‚‰è¿½åŠ 


## C++ Compiler ã¨ Windows 10 SDK ãŒãªã„
```
Internal build system error. BuildProgram exited with code 1.
error: Could not set up a toolchain for Architecture x64. Make sure you have the right build tools installed for il2cpp builds. Details:
IL2CPP C++ code builder is unable to build C++ code. In order to build C++ code for Windows Desktop, you must have one of these installed:
 * Visual Studio 2022 or newer with C++ compilers and Windows 10 (or newer) SDK (recommended)
 * Visual Studio 2019 with C++ compilers and Windows 10 (or newer) SDK
 * Visual Studio 2017 with C++ compilers and Windows 10 (or newer) SDK
 * Visual Studio 2015 with C++ compilers and Windows 10 (or newer) SDK

Visual Studio 2017 (or newer) is detected using `vswhere.exe` as well as VSCOMNTOOLS environment variables.
Visual Studio 2015 is detected by looking at "SOFTWARE\Microsoft\VisualStudio\14.0_Config\InstallDir" in the registry as well as VSCOMNTOOLS environment variables.
Windows 10 (or newer) SDK is detected by looking at "SOFTWARE\Wow6432Node\Microsoft\Microsoft SDKs\Windows\v10.0\InstallationFolder" in the registry.

Unable to detect any compatible Visual Studio installation!
 * Found Visual Studio 2022 installation without C++ tool components
 * Found Visual Studio 2019 installation without C++ tool components

Windows 10 (or newer) SDK is not installed. You can install from here: https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk/


Unity.IL2CPP.Bee.BuildLogic.ToolchainNotFoundException: IL2CPP C++ code builder is unable to build C++ code. In order to build C++ code for Windows Desktop, you must have one of these installed:
 * Visual Studio 2022 or newer with C++ compilers and Windows 10 (or newer) SDK (recommended)
 * Visual Studio 2019 with C++ compilers and Windows 10 (or newer) SDK
 * Visual Studio 2017 with C++ compilers and Windows 10 (or newer) SDK
 * Visual Studio 2015 with C++ compilers and Windows 10 (or newer) SDK

Visual Studio 2017 (or newer) is detected using `vswhere.exe` as well as VSCOMNTOOLS environment variables.
Visual Studio 2015 is detected by looking at "SOFTWARE\Microsoft\VisualStudio\14.0_Config\InstallDir" in the registry as well as VSCOMNTOOLS environment variables.
Windows 10 (or newer) SDK is detected by looking at "SOFTWARE\Wow6432Node\Microsoft\Microsoft SDKs\Windows\v10.0\InstallationFolder" in the registry.

Unable to detect any compatible Visual Studio installation!
 * Found Visual Studio 2022 installation without C++ tool components
 * Found Visual Studio 2019 installation without C++ tool components

Windows 10 (or newer) SDK is not installed. You can install from here: https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk/


   at Unity.IL2CPP.Bee.BuildLogic.WindowsDesktop.WindowsDesktopBuildLogic.UserAvailableToolchainFor(Architecture architecture, NPath toolChainPath, NPath sysRootPath, Boolean targetIsSimulator)
   at PlayerBuildProgramLibrary.PlayerBuildProgramBase.GetIl2CppToolChain(PlatformBuildLogic platform, Architecture architecture, NPath toolChainPath, NPath sysrootPath)
   at PlayerBuildProgramLibrary.PlayerBuildProgramBase.SetupIl2CppBuild()
   at PlayerBuildProgramLibrary.PlayerBuildProgramBase.<SetupPlayerBuild>b__94_0()
   at Bee.Core.TinyProfiler2Base.Section[T](String label, Func`1 func, Dictionary`2 metadata)
   at PlayerBuildProgramLibrary.PlayerBuildProgramBase.SetupPlayerBuild()
   at WinPlayerBuildProgram.WinPlayerBuildProgram.SetupPlayerBuild()
   at PlayerBuildProgramLibrary.PlayerBuildProgramBase.RunBuildProgram()
   at PlayerBuildProgramTypeWrapper.Run(String[] args)
   at Program.Main(String[] args)
UnityEngine.GUIUtility:ProcessEvent (int,intptr,bool&)
```

Visual Studio Installerã‚’èµ·å‹•ã—ã¦ å¤‰æ›´ -> C++ ã«ã‚ˆã‚‹ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é–‹ç™º ã‚’é¸æŠã—ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚


## ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œä¸­ã€ç”Ÿæˆã—ãŸCubeãŒMaterialã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
ãƒ“ãƒ«ãƒ‰ã§ã¯ CreatePrimitive è¿½åŠ ã•ã‚Œã‚‹ Cube ã«æœŸå¾…é€šã‚Šã® Material ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚Œãªã„ã£ã½ã„ã®ã§ã€Cube ç”Ÿæˆç›´å¾Œã® Material ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

:::

# ã•ã„ã”ã«

æ„å¤–ã¨ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆãŒå¤šãã¦ç’°å¢ƒæ§‹ç¯‰ãŒå¤§å¤‰ã§ã—ãŸãŒã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼ã©ã¡ã‚‰ã‚‚ C# ã§å®Ÿè£…ã§ãã‚‹ã®ã¯å¬‰ã—ã„ã§ã™ã­ï¼

ä»Šå¾Œã€MagicOnion ãƒã‚¿ã¨ã—ã¦ä»¥ä¸‹ã®å†…å®¹ã§è¨˜äº‹ã‚’ä»Šå¾Œæ›¸ã‘ãŸã‚‰ã„ã„ãªãã¨æ€ã£ã¦ã„ã¾ã™ã€‚

- MagicOnion + MessgePack + YetAnotherHttpHandler ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã‚‹ï¼ˆæœ¬è¨˜äº‹ï¼‰ 
- [Unity(YetAnotherHttpHandler)ã¨MagicOnionã§è‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’ä½¿ã£ãŸHTTPS&HTTP/2é€šä¿¡](https://zenn.dev/toutou/articles/2611fe24bd1939)
- MagicOnion Server ã‚³ãƒ³ãƒ†ãƒŠã‚’ GCP ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
- DFrame ã§ MagicOnion Server ã®è² è·è©¦é¨“
- TLS çµ‚ç«¯ç”¨ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·è¿½åŠ ã«ã‚ˆã‚‹ã‚µãƒ¼ãƒãƒ¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å·®


# å‚è€ƒè¨˜äº‹
- [The future of gRPC in C# belongs to grpc-dotnet | gRPC](https://grpc.io/blog/grpc-csharp-future/)
- [neue cc - Unityç”¨ã®HTTP/2(gRPC) Clientã€YetAnotherHttpHandlerã‚’å…¬é–‹ã—ã¾ã—ãŸ](https://neue.cc/2023/07/28_yetanotherhttphandler.html)
- [Unityã§ã‚‚grpc-dotnetã‚’ä½¿ã£ãŸgRPCãŒã—ãŸã„ - Activ8 Tech Blog](https://synamon.hatenablog.com/entry/grpc-dotnet-unity)
- [Unityã¨C#ã§ç°¡å˜ã«gRPCã™ã‚‹ in 2023](https://zenn.dev/turing_motors/articles/7f5cc78c5d5b55)
- [MagicOnion+MemoryPack+YetAnotherHttpHandler on Azure Container Apps æ§‹ç¯‰ã®ãƒ­ã‚°](https://zenn.dev/fumio_dev/scraps/0dd9b71c81a4f2)
  