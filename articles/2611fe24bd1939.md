---
title: "Unity(YetAnotherHttpHandler)ã¨MagicOnionã§è‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’ä½¿ã£ãŸHTTPS&HTTP/2é€šä¿¡ã—ã¦ã¿ãŸ"
emoji: "ğŸ™Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Unity","MagicOnion","HTTP2","https","è‡ªå·±è¨¼æ˜æ›¸",]
published: false
---

# æ¦‚è¦

[MagicOnion + MessagePack + YetAnotherHttpHandler ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã‚’è¡Œã†](https://zenn.dev/toutou/articles/7918da3d1a9e1d) ã®ç¶šç·¨ã§ã™ã€‚
è‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’ä½¿ã£ã¦ Unity(YetAnotherHttpClient)ã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ¼ãƒãƒ¼ï¼ˆMagicOnionï¼‰ã§ HTTPS & HTTP/2 é€šä¿¡ã™ã‚‹æ‰‹é †ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

åŸºæœ¬ã¯[Configure SSL/TLS | MagicOnion](https://cysharp.github.io/MagicOnion/articles/deployment/https.html#tls-on-localhost) ã®é€šã‚Šã§ã™ãŒã€ã¡ã‚‡ã£ã¨èº“ã„ãŸéƒ¨åˆ†ãŒã‚ã£ãŸã®ã§ã€ã†ã¾ãã„ã£ãŸæ–¹æ³•ã‚’ç´¹ä»‹ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚

ä»¥å‰ã¯ã€æ¨™æº–ã®handlerã§ã‚«ã‚¹ã‚¿ãƒ æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã—ã¦è¨¼æ˜æ›¸æ¤œè¨¼ã‚’ã™ã‚‹ã“ã¨ãŒã§ããŸã®ã§ã™ãŒã€ã‚«ã‚¹ã‚¿ãƒ æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ãŒè¿½åŠ ã§ããªã„ä»£ã‚ã‚Šã«ã€ãƒ«ãƒ¼ãƒˆè¨¼æ˜æ›¸ã‚’æ¸¡ã™ã“ã¨ã§ã¡ã‚ƒã‚“ã¨æ¤œè¨¼ã—ã¦ãã‚Œã¾ã™ã€‚
YetAnotherHttpHandler ãŒã—ã£ã‹ã‚Šã¨è¨¼æ˜æ›¸ã®æ¤œè¨¼ã‚’ã‚„ã£ã¦ãã‚Œã¾ã™ã€‚

https://cysharp.github.io/MagicOnion/articles/deployment/https.html#tls-on-localhost

# ç’°å¢ƒ
## é–‹ç™ºç’°å¢ƒ
- Windows 11
- WSL 2
  - [WSL ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« | Microsoft Learn](https://learn.microsoft.com/ja-jp/windows/wsl/install)
  - Ubuntu 20.04
    - WSL ã® Linux ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ä¸Šè¨˜ã‚’ä½¿ã£ã¦ã„ã¾ã—ãŸãŒã€OpenSSL 3 ç³»ãŒä½¿ãˆã‚‹ Linux ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚ã‚Œã°ãªã‚“ã§ã‚‚ã‚ˆã„ã§ã™ã€‚
    - OpenSSL ã§è‡ªå·±è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ã¾ã™ã€‚ 

## ä¸»ãªä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- YetAnotherHttpHandler
  - Unity ã§åˆ©ç”¨ã§ãã‚‹ HTTP/2 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ 
- MagicOnion
  - HTTP/2 ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦åˆ©ç”¨ã§ãã‚‹ï¼
- OpenSSL 3.2.0
  - è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã§ãã‚‹ãƒ„ãƒ¼ãƒ«
  - OpenSSL 3 ç³»ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
  - YetAnotherHttpHandler ã¯è„†å¼±æ€§ã®å­˜åœ¨ã™ã‚‹ OpenSSL 1 ç³»ã§ç”Ÿæˆã—ãŸè¨¼æ˜æ›¸ã¯ä¿¡é ¼ã—ã¾ã›ã‚“ã€‚


# æ‰‹é †

## MagicOnion Server ã¨ Unity Client ã®æº–å‚™

MagicOnion Server ã¨ Unity Clientï¼ˆYetAnotherHttpHandlerï¼‰ã®ä¸€ä¾‹ã¨ã—ã¦ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ clone ã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚
- MagicOnion Server
  - [tou-tou/magiconion-sample-server](https://github.com/tou-tou/magiconion-sample-server)
- Unity Client
  - [tou-tou/magiconion-sample-client](https://github.com/tou-tou/magiconion-sample-client)
  
## (å¿…è¦ãªäººã¯) Ubuntu 20.04 ã§ OpenSSL 3 ç³»ã¸æ›´æ–°

OpenSSL 1.1.1 ã§ç”Ÿæˆã—ãŸè¨¼æ˜æ›¸ã ã¨ YetAntherHttpHandler ãŒè¨¼æ˜æ›¸æ¤œè¨¼æ™‚ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãªã„æ—¨ã®ã‚¨ãƒ©ãƒ¼ã‚’å‡ºåŠ›ã—ã¦ã—ã¾ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€OpenSSL 3 ç³»ã«æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```
HttpRequestException: error trying to connect: invalid peer certificate: Other(UnsupportedCertVersion)
```

:::message
Ubuntu 20.04 ã¯ ã‚µãƒãƒ¼ãƒˆçµ‚äº†ã—ãŸï¼ˆ2023/09/11ï¼‰OpenSSL1.1.1 ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€æœ€æ–°ç‰ˆã«æ›´æ–°ã—ã¾ã™ã€‚
:::

[Ubuntu 20.04 ã§ OpenSSL 3.2.0 ã«æ›´æ–°ã™ã‚‹](https://zenn.dev/toutou/articles/c14d73c458f18d) ã‚’å‚è€ƒã«æ›´æ–°ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã« OpenSSL ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ 3.2.0 ä»¥ä¸Šã§ã‚ã‚Œã° OK ã§ã™ã€‚
```
$  openssl version
OpenSSL 3.2.0 23 Nov 2023 (Library: OpenSSL 3.2.0 23 Nov 2023)
```


## è¨¼æ˜æ›¸ã®ä½œæˆ
pfx ã¨ key ã¨ crt ã‚’ç”Ÿæˆã—ã¾ã™ã€‚



ã¾ãšã¯ã€ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ç§»å‹•ã—ã¾ã™ã€‚

ä¾‹ãˆã°ã€`Ubuntu` ã¸`bash`ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã€ magiconion-sample-server ã«ç§»å‹•ã—ã¾ã™ã€‚ 

### Windows ã®ãƒ›ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†

ç®¡ç†è€…æ¨©é™ã§hostãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¡ãƒ¢å¸³ãªã©ã§é–‹ãã¾ã™ã€‚
ä¾‹ãˆã°ä»¥ä¸‹ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```
127.0.0.1 dummy.example.com
```

### ç§˜å¯†éµã®ç”Ÿæˆã§ã™ã€‚
```bash:bash
# path-to magiconion-sample-server
mkdir Server/certificate
cd Server/certificate
openssl genrsa 4096 > server.key
```


### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚‚ã¨ã«è¨¼æ˜æ›¸ã‚’ç”Ÿæˆã—ã¾ã™

subjectAltNameã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚ŒãŒãªã„å ´åˆã€YetAnotherHttpHandlerã¯è¨¼æ˜æ›¸æ¤œè¨¼æ™‚ã«ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

```
HttpRequestException: error trying to connect: invalid peer certificate: UnknownIssuer
```

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```cnf:myssl.cnf
[ req ]
default_bits       = 4096
default_md         = sha256
prompt             = no
encrypt_key        = no
distinguished_name = dn

[ dn ]
CN=dummy.example.com

[ ext ]
basicConstraints=CA:FALSE
keyUsage=digitalSignature, keyEncipherment
subjectAltName=@alt_names

[ alt_names ]
DNS.1=dummy.example.com
DNS.2=www.dummy.example.com
```

```bash:bash
openssl req -new -x509 -key server.key -out server.crt -days 7300 -config myssl.cnf -extensions ext
```

### ã‚µãƒ¼ãƒãƒ¼ç”¨ pfx ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
pfxãƒ•ã‚¡ã‚¤ãƒ«ã¨ã¯...

```bash:bash
openssl pkcs12 -export -out server.pfx -inkey server.key -in server.crt
```

appsettigs.json ã«ç§˜å¯†éµã¨csrã®å ´æ‰€ã‚’å®šç¾©ã—ã¦ãŠã‘ã°ã„ã‘ã‚‹ã¨æ€ã£ãŸãŒãªãœã‹ã ã‚ã ã£ãŸã€‚pfxãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦program.csã§èª­ã¿è¾¼ã¾ãªã‘ã‚Œã°ã„ã‹ãªã„ã£ã½ã„ãªãœã‹ã€ã¾ã§ã¯èª¿ã¹ã‚‹ä½™åŠ›ãŒãªã‹ã£ãŸã§ã™...

### è¨¼æ˜æ›¸ã®ç¢ºèª
```bash:bash
 openssl x509 -in server.crt -text -noout
 Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            48:9a:ec:0f:5f:af:7d:6a:69:b0:d4:57:1e:a2:41:13:57:fe:62:e9
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=dummy.example.com
        Validity
            Not Before: Jan  8 10:31:28 2024 GMT
            Not After : Jan  7 10:31:28 2025 GMT
        Subject: CN=dummy.example.com
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (4096 bit)
                Modulus:
                    00:9b:16:ad:a6:1f:11:fc:c4:7a:77:46:49:6b:0d:
                    ...(çœç•¥)
                    2d:8d:f9
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Basic Constraints:
                CA:FALSE
            X509v3 Key Usage:
                Digital Signature, Key Encipherment
            X509v3 Subject Alternative Name:
                DNS:dummy.example.com, DNS:www.dummy.example.com
            X509v3 Subject Key Identifier:
                A4:A8:BA:AF:16:C7:00:FE:98:A2:B8:10:9B:B9:77:60:15:2D:5B:3E
    Signature Algorithm: sha256WithRSAEncryption
    Signature Value:
        4e:90:0f:e9:0a:f6:1b:24:72:44:b1:be:07:95:62:e4:2f:b9:
        ...(çœç•¥)
        f7:21:e1:74:e5:e7:b9:9c
 ```

# ã‚µãƒ¼ãƒãƒ¼ã®è¨­å®š
ã‚µãƒ³ãƒ—ãƒ«ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆã€`Program.cs`ã€`Server.csproj`


## ã‚µãƒ¼ãƒãƒ¼ã®å®Ÿè£…
```json:appsettigs.json
{
  "Kestrel": {
    "Endpoints": {
      "Grpc": {
        "Url": "http://dummy.example.com:5000",
        "Protocols": "Http2"
      },
      "Https": {
        "Url": "https://dummy.example.com:5001",
        "Protocols": "Http1AndHttp2"
      },
      "Http": {
        "Url": "http://dummy.example.com:5002",
        "Protocols": "Http1"
      }
    }
  }
}
```

# Unity ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è¨­å®š

Assets/StreamingAssetsã‚’ä½œæˆã—ã€ãã“ã« certificate/server.crt ã‚’ç½®ãã¾ã™ã€‚


# å‹•ã„ãŸ


# ãŠã‚ã‚Šã«


# å‚è€ƒ
- [Configure SSL/TLS | MagicOnion](https://cysharp.github.io/MagicOnion/articles/deployment/https.html#tls-on-localhost)
- [ã€å›³è§£ã€‘ã‚ˆãåˆ†ã‹ã‚‹ãƒ‡ã‚¸ã‚¿ãƒ«è¨¼æ˜æ›¸(SSLè¨¼æ˜æ›¸)ã®ä»•çµ„ã¿ ã€œhttpsé€šä¿¡ãƒ•ãƒ­ãƒ¼,ç™ºè¡Œæ‰‹é †,CSR,è‡ªå·±ç½²å(ã‚ªãƒ¬ã‚ªãƒ¬)è¨¼æ˜æ›¸,ãƒ«ãƒ¼ãƒˆè¨¼æ˜æ›¸,ä¸­é–“è¨¼æ˜æ›¸ã®å¿…è¦æ€§ã‚„æ‰±ã„ã«ã¤ã„ã¦ã€œ | SEã®é“æ¨™](https://milestone-of-se.nesuke.com/sv-advanced/digicert/digital-certification-summary/)




# ãƒ¡ãƒ¢
ã€ŒMagicOnion ã¨ YetAnotherHttpHandler ã‚’ç”¨ã„ãŸè‡ªå·±ç½²åè¨¼æ˜æ›¸ã«ã‚ˆã‚‹ HTTP/2ãƒ»HTTPS é€šä¿¡ã€ã¨ã„ã†ã‚¿ã‚¤ãƒˆãƒ«ã®è¨˜äº‹ã‚’æ›¸ãå ´åˆã€ä»¥ä¸‹ã®ç« ç«‹ã¦ã‚’ææ¡ˆã—ã¾ã™ã€‚ã“ã®æ§‹æˆã¯ã€æŠ€è¡“çš„ãªè©³ç´°ã‚’åŒ…æ‹¬çš„ã«æ‰±ã„ã¤ã¤ã€èª­è€…ã«ã¨ã£ã¦åˆ†ã‹ã‚Šã‚„ã™ãã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

### è¨˜äº‹ã®æ§‹æˆæ¡ˆ

1. **ã¯ã˜ã‚ã«**
   - è¨˜äº‹ã®ç›®çš„ã¨æ¦‚è¦ã®èª¬æ˜ã€‚
   - MagicOnion ã¨ YetAnotherHttpHandler ã®ç°¡å˜ãªç´¹ä»‹ã€‚

2. **æŠ€è¡“çš„èƒŒæ™¯**
   - HTTP/2 ã¨ HTTPS ã®åŸºæœ¬ã¨é‡è¦æ€§ã€‚
   - è‡ªå·±ç½²åè¨¼æ˜æ›¸ã®å½¹å‰²ã¨é™ç•Œã€‚

3. **MagicOnion ã®æ¦‚è¦**
   - MagicOnion ã®ä¸»ãªç‰¹å¾´ã¨åˆ©ç‚¹ã€‚
   - HTTP/2 ã«ãŠã‘ã‚‹MagicOnionã®å½¹å‰²ã€‚

4. **YetAnotherHttpHandler ã®æ¦‚è¦**
   - YetAnotherHttpHandler ã®ç‰¹å¾´ã¨ã€ãªãœã“ã‚Œã‚’é¸ã‚“ã ã‹ã®èª¬æ˜ã€‚

5. **è‡ªå·±ç½²åè¨¼æ˜æ›¸ã®ç”Ÿæˆã¨è¨­å®š**
   - è‡ªå·±ç½²åè¨¼æ˜æ›¸ã®ç”Ÿæˆæ–¹æ³•ã€‚
   - MagicOnion ã¨ YetAnotherHttpHandler ã«ãŠã‘ã‚‹è¨¼æ˜æ›¸ã®è¨­å®šæ–¹æ³•ã€‚

6. **HTTP/2 ã¨ HTTPS ã«ã‚ˆã‚‹é€šä¿¡ã®å®Ÿè£…**
   - MagicOnion ã¨ YetAnotherHttpHandler ã‚’ä½¿ç”¨ã—ã¦HTTPSé€šä¿¡ã‚’è¨­å®šã™ã‚‹æ‰‹é †ã€‚
   - ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¨å®Ÿè£…ã®èª¬æ˜ã€‚

7. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®è€ƒæ…®äº‹é …**
   - è‡ªå·±ç½²åè¨¼æ˜æ›¸ã®ä½¿ç”¨ã«ä¼´ã†ãƒªã‚¹ã‚¯ã€‚
   - å®‰å…¨ãªé€šä¿¡ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã€‚

8. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã¨è©•ä¾¡**
   - å®Ÿè£…ã—ãŸã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆæ–¹æ³•ã€‚
   - ãƒ†ã‚¹ãƒˆçµæœã¨ãã®åˆ†æã€‚

9. **ã¾ã¨ã‚ã¨ä»Šå¾Œã®å±•æœ›**
   - è¨˜äº‹ã®è¦ç‚¹ã®å†ç¢ºèªã€‚
   - ä»Šå¾Œã®æŠ€è¡“çš„ãªé€²å±•ã‚„äºˆæƒ³ã•ã‚Œã‚‹ãƒˆãƒ¬ãƒ³ãƒ‰ã€‚

10. **å‚è€ƒæ–‡çŒ®**
    - è¨˜äº‹åŸ·ç­†ã«ä½¿ç”¨ã—ãŸè³‡æ–™ã€å‚è€ƒã«ã—ãŸæ–‡çŒ®ã®ãƒªã‚¹ãƒˆã€‚

### è£œè¶³
- **èª­è€…å±¤ã®ç‰¹å®š**: è¨˜äº‹ã®å¯¾è±¡èª­è€…ï¼ˆä¾‹ãˆã°ã€ä¸­ç´šã‹ã‚‰ä¸Šç´šã®é–‹ç™ºè€…ãªã©ï¼‰ã‚’ç‰¹å®šã—ã€ãã®ãƒ¬ãƒ™ãƒ«ã«åˆã‚ã›ãŸè¨€è‘‰é£ã„ã‚„èª¬æ˜ã®æ·±ã•ã‚’èª¿æ•´ã™ã‚‹ã€‚
- **å›³è¡¨ã®æ´»ç”¨**: æŠ€è¡“çš„ãªå†…å®¹ã‚’è¦–è¦šçš„ã«ç¤ºã™ãŸã‚ã«ã€å›³è¡¨ã‚„ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚’æ´»ç”¨ã™ã‚‹ã€‚
- **å®Ÿä¾‹ã®æä¾›**: å®Ÿéš›ã®ã‚·ãƒŠãƒªã‚ªã«åŸºã¥ãä¾‹ã‚’æä¾›ã—ã¦ã€ç†è«–çš„ãªèª¬æ˜ã‚’è£œå®Œã™ã‚‹ã€‚

ã“ã®ç« ç«‹ã¦ã¯ã€æŠ€è¡“çš„ãªæ·±ã•ã¨èª­ã¿ã‚„ã™ã•ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚ŠãªãŒã‚‰ã€ä¸»é¡Œã«é–¢ã™ã‚‹åŒ…æ‹¬çš„ãªç†è§£ã‚’æä¾›ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚