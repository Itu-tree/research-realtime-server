---
title: "MagicOnion Server を 自己証明書で HTTPS 化"
emoji: "🙌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["MagicOnion","TLS","HTTPS","自己証明書"]
published: false
---
# 概要
MagicOnionServer において自己証明書を発行して https で通信する手順を記述します。

[Configure SSL/TLS | MagicOnion](https://cysharp.github.io/MagicOnion/articles/deployment/https.html#generate-self-signed-certificate) をベースに進めます。


https://cysharp.github.io/MagicOnion/articles/deployment/https.html#tls-on-localhost

# 環境
- Windows 11
- WSL 2
  - [WSL のインストール | Microsoft Learn](https://learn.microsoft.com/ja-jp/windows/wsl/install)
  - Ubuntu 20.04
    - WSL の Linux ディストリビューションとして上記を使っていましたが、OpenSSL 3 系が使える Linux ディストリビューションであればなんでもよいです。
    - OpenSSL で自己証明書を発行します。 


# 手順

## MagicOnion Server と Unity Client の準備

MagicOnion Server と Unity Client（MagicOnion Client）の一例として以下のリポジトリを clone して利用します。
- MagicOnion Server
  - [tou-tou/magiconion-sample-server](https://github.com/tou-tou/magiconion-sample-server)
- Unity Client
  - [tou-tou/magiconion-sample-client](https://github.com/tou-tou/magiconion-sample-client)
  
## Ubuntu 20.04 で OpenSSL の更新

:::message
Ubuntu 20.04 は サポート終了した（2023/09/11）OpenSSL1.1.1 がインストールされているので、最新版に更新します。
:::

[Ubuntu 20.04 で OpenSSL 3.2.0 に更新する](https://zenn.dev/toutou/articles/c14d73c458f18d) を参考に更新します。



![Alt text](image.png)

## 証明書の作成
まずは、サーバープロジェクトに移動します。

例えば、パワーシェルで magiconion-sample-server プロジェクトに移動して`bash`で bash にログインします。

```bash:powershell
# path to servre project
> bash
```

```bash:bash
mkdir certificate
openssl genrsa 4096 > server.key
 1876  openssl req -new -sha256 -key server.key -out server.csr -subj "/C=JP/ST=Tokyo/L=Tokyo/O=MagicOnion Demo/OU=Dev/CN=dummy.example.com"
 1877  openssl x509 -req -in server.csr -signkey server.key -out server.crt -days 7300 -extensions server
 openssl pkcs12 -export -out server.pfx -inkey server.key -in server.crt

 1878  cd Server/
 1879  cd certificate/
 openssl x509 -in server.crt -text -noout
 ```
 Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            48:9a:ec:0f:5f:af:7d:6a:69:b0:d4:57:1e:a2:41:13:57:fe:62:e9
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=dummy.example.com
        Validity
            Not Before: Jan  8 10:31:28 2024 GMT
            Not After : Jan  7 10:31:28 2025 GMT
        Subject: CN=dummy.example.com
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (4096 bit)
                Modulus:
                    00:9b:16:ad:a6:1f:11:fc:c4:7a:77:46:49:6b:0d:
                    ca:92:23:de:bf:58:bc:e2:44:c6:98:d0:b3:9a:a7:
                    97:d6:27:c3:b5:ff:4d:ce:45:84:37:70:a5:10:03:
                    29:c8:d9:7f:8c:8e:2c:7c:e4:d8:e1:21:62:ac:cc:
                    e2:a5:64:5f:c2:59:be:0c:eb:3e:6f:3a:79:68:7c:
                    74:ee:9f:55:e1:c4:4c:2a:59:84:fe:f3:bd:a4:a5:
                    06:a8:25:d6:da:67:df:9d:92:e8:50:a7:0f:66:a9:
                    af:db:3e:f5:ce:11:93:21:d4:a8:7c:b0:94:5e:1e:
                    5e:95:d8:90:a0:d4:15:4f:f0:34:99:74:9f:e9:cb:
                    0e:b7:e7:35:1f:55:e8:90:df:aa:bd:d2:3c:a0:62:
                    0a:8e:6d:30:4b:cc:59:96:38:d5:71:52:9e:d7:82:
                    a2:a7:e1:d8:29:5e:e3:5e:44:a5:21:6a:4c:49:ad:
                    cd:e8:17:37:1c:6c:3d:4d:57:0b:11:49:22:b4:47:
                    a6:df:3d:e5:01:a2:64:c5:34:ab:f2:4a:b4:fb:43:
                    8c:b3:10:58:1d:fe:f6:99:e5:d5:5b:56:55:90:c6:
                    d4:35:6f:45:41:56:77:bb:ea:0d:6c:e9:14:8e:b9:
                    fa:57:fa:8d:3c:69:ae:30:a1:08:bf:76:99:66:4f:
                    d0:53:82:ee:c2:78:2e:fe:4b:56:b5:8a:be:53:78:
                    a4:dd:7c:64:30:64:09:d1:da:be:9f:fa:97:f1:a9:
                    08:f9:7b:e8:ea:5d:81:8b:3a:44:59:fc:80:ee:57:
                    b2:b9:04:a4:d2:35:39:f4:a4:d9:61:44:f2:8b:ae:
                    fd:b3:f7:91:c7:fe:ae:cb:33:1e:8a:59:f3:7c:7f:
                    0d:e7:74:0b:9c:3b:2c:9c:84:47:74:ea:66:86:28:
                    d5:98:8c:a9:b7:0e:80:cc:a0:bd:3e:90:28:7e:97:
                    ec:7f:62:a4:f8:d3:25:6c:20:c8:fa:ff:d3:d5:0a:
                    9d:bb:29:aa:a9:d6:65:47:ac:34:98:e3:58:9f:ba:
                    42:7e:43:75:d7:8a:2b:f4:a8:66:f1:9d:8d:cc:8e:
                    25:69:c8:3b:80:71:d7:05:2c:6a:08:d3:74:7d:7d:
                    86:96:68:44:39:70:58:49:7f:11:95:d4:35:17:13:
                    a4:a6:8b:48:be:5f:d3:62:e1:64:65:27:ea:13:be:
                    f9:e3:9d:7d:0d:ee:eb:7b:b0:f4:53:10:ad:24:35:
                    0d:64:22:d9:49:d3:0b:2b:fe:2a:1f:e7:24:57:8c:
                    59:4a:51:aa:be:bd:39:ee:44:19:0e:50:11:cc:be:
                    0f:55:71:8c:43:80:89:b6:b5:a5:ca:13:89:2d:15:
                    2d:8d:f9
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Basic Constraints:
                CA:FALSE
            X509v3 Key Usage:
                Digital Signature, Key Encipherment
            X509v3 Subject Alternative Name:
                DNS:dummy.example.com, DNS:www.dummy.example.com
            X509v3 Subject Key Identifier:
                A4:A8:BA:AF:16:C7:00:FE:98:A2:B8:10:9B:B9:77:60:15:2D:5B:3E
    Signature Algorithm: sha256WithRSAEncryption
    Signature Value:
        4e:90:0f:e9:0a:f6:1b:24:72:44:b1:be:07:95:62:e4:2f:b9:
        9b:4f:8d:d7:a4:1b:f4:bc:30:b9:2e:cc:30:71:9f:f8:45:46:
        c6:8b:c3:55:4d:7e:98:c7:52:9a:9f:a3:75:a0:a2:21:09:6c:
        d2:32:01:43:f6:d9:d8:c8:a8:83:7a:92:c3:bc:96:68:1f:b0:
        9b:c4:4a:f6:4a:4c:df:c7:8c:a4:28:57:9e:e4:4e:2b:2d:25:
        97:15:a7:22:a0:66:d6:d3:a4:64:0f:bd:bf:49:66:fc:1d:fd:
        e8:90:ce:8d:53:4d:88:40:3c:2b:63:ff:7c:7a:e2:92:3c:c8:
        b5:9a:7d:2f:df:41:41:a6:e3:16:9b:e0:0c:e0:0d:49:88:55:
        eb:af:a7:43:f0:1f:1c:1a:80:53:e4:fa:36:52:62:f1:06:f6:
        f9:67:cd:9f:85:de:00:5b:72:0a:a5:73:59:95:49:ff:7b:df:
        41:6f:e3:b9:3e:1f:b9:00:ba:e1:4a:bd:50:fb:59:a4:f3:bb:
        db:cb:ec:cc:2b:4b:40:81:fc:2d:24:85:65:17:eb:a1:1e:07:
        fe:ac:8b:23:36:08:c8:dd:eb:72:3f:48:67:87:ea:f4:16:0d:
        29:62:18:92:12:00:54:8f:12:0e:f5:d2:10:9f:c0:d2:52:c1:
        19:be:46:1f:f4:4d:fc:2f:c4:bd:44:7e:cb:38:5b:1e:03:6a:
        05:15:01:ca:91:06:1d:ee:da:4b:aa:27:0a:22:32:04:5c:4e:
        e6:03:8d:b5:22:bc:c6:cc:b2:c2:56:98:80:1f:18:c4:37:11:
        e5:98:08:77:a4:94:d6:70:44:ad:65:2c:b0:32:32:e1:98:ea:
        d4:85:54:ad:34:a0:58:52:13:1c:08:b7:03:08:8e:3a:02:0a:
        81:36:9c:d7:35:b0:e2:f8:cb:86:95:3b:8a:25:e0:78:2e:52:
        45:e4:01:7e:95:09:20:ad:47:fd:ac:d7:de:d3:0e:6b:03:c8:
        4d:d2:47:df:e0:73:c7:a6:a7:6d:24:e4:42:36:7a:08:27:99:
        f7:4f:26:fe:fe:38:07:99:63:33:51:fa:c1:0c:09:7f:84:b3:
        3e:ea:72:49:d9:65:8a:82:7b:4e:7f:c0:fb:f2:f6:16:f4:f4:
        70:ba:24:12:b5:ef:d0:c2:ab:53:70:f9:c9:52:21:a6:b1:ca:
        85:d4:7d:00:ff:4a:6d:19:7e:b7:e1:80:a6:82:fb:69:b1:f0:
        4b:f5:39:e4:83:a1:2f:c8:df:f8:f3:81:a8:f5:1c:8a:1c:c6:
        e3:a9:6b:81:36:72:dc:5f:bb:9d:cb:10:97:d7:9f:00:ea:67:
        f7:21:e1:74:e5:e7:b9:9c

 
 ```
openssl req -new -x509 -key server.key -out server.crt -days 365 -config openssl.cnf
openssl req -new -x509 -key server.key -out server.crt -days 365 -config myssl.cnf -extensions ext


openssl pkcs12 -export -out server.pfx -inkey server.key -in server.crt
```
![Alt text](image-1.png)


openssl pkcs12 -export -out certificate.pfx -inkey key.pem -in cert.pem


## Unity クライアントの設定

Assets/StreamingAssetsを作成し、そこに certificate/server.crt を置きます。

# 参考
- [自己署名証明書を作ってルート証明書として読み込んでみた](https://pvision.jp/tech/2023/04/importing-self-signed-certificate-as-root-certificate/)
- [【図解】よく分かるデジタル証明書(SSL証明書)の仕組み 〜https通信フロー,発行手順,CSR,自己署名(オレオレ)証明書,ルート証明書,中間証明書の必要性や扱いについて〜 | SEの道標](https://milestone-of-se.nesuke.com/sv-advanced/digicert/digital-certification-summary/)