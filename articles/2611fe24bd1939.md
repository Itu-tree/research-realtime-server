---
title: "Unity(YetAnotherHttpHandler)ã¨MagicOnionã§è‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’ä½¿ã£ãŸHTTPS&HTTP/2é€šä¿¡"
emoji: "ğŸ™Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Unity","MagicOnion","HTTP2","https","è‡ªå·±ç½²åè¨¼æ˜æ›¸",]
published: true
---

# æ¦‚è¦

[MagicOnion + MessagePack + YetAnotherHttpHandler ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã‚’è¡Œã†](https://zenn.dev/toutou/articles/7918da3d1a9e1d) ã®ç¶šç·¨ã§ã™ã€‚
è‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’ä½¿ã£ã¦ Unity(YetAnotherHttpClient)ã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ¼ãƒãƒ¼ï¼ˆMagicOnionï¼‰ã§ HTTPS & HTTP/2 é€šä¿¡ã™ã‚‹æ‰‹é †ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

åŸºæœ¬ã¯[Configure SSL/TLS | MagicOnion](https://cysharp.github.io/MagicOnion/articles/deployment/https.html#tls-on-localhost) ã®é€šã‚Šã§ã™ãŒã€YetAnotherHttpHandler ã‚’ä½¿ã£ãŸã‚Šã€æœ€æ–°ã® dotnet8 ã‚’ä½¿ã£ãŸã‚Šã™ã‚‹å ´åˆã¯ã€æ‰‹é †ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã® HTTPS&HTTP/2 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦ YetAnotherHttpHandler ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚YetAnotherHttpHandler ã¯ `RootCertificates`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§è‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’å†…éƒ¨ã§æ¤œè¨¼ã—ã¦ãã‚Œã¾ã™ã€‚[YetAnotherHttpHandler #Using custom root certificates - GitHub](https://github.com/Cysharp/YetAnotherHttpHandler?tab=readme-ov-file#using-custom-root-certificates)

ã¾ãŸã€https é€šä¿¡ã®ãƒ•ãƒ­ãƒ¼ã«ã¤ã„ã¦ã¯ [ã€å›³è§£ã€‘ã‚ˆãåˆ†ã‹ã‚‹ãƒ‡ã‚¸ã‚¿ãƒ«è¨¼æ˜æ›¸(SSLè¨¼æ˜æ›¸)ã®ä»•çµ„ã¿ ã€œhttpsé€šä¿¡ãƒ•ãƒ­ãƒ¼,ç™ºè¡Œæ‰‹é †,CSR,è‡ªå·±ç½²å(ã‚ªãƒ¬ã‚ªãƒ¬)è¨¼æ˜æ›¸,ãƒ«ãƒ¼ãƒˆè¨¼æ˜æ›¸,ä¸­é–“è¨¼æ˜æ›¸ã®å¿…è¦æ€§ã‚„æ‰±ã„ã«ã¤ã„ã¦ã€œ | SEã®é“æ¨™](https://milestone-of-se.nesuke.com/sv-advanced/digicert/digital-certification-summary/) ãŒåˆ†ã‹ã‚Šæ˜“ã„ã§ã™ã€‚

# ç’°å¢ƒ
## é–‹ç™ºç’°å¢ƒ
- Windows 11
- WSL 2
  - [WSL ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« | Microsoft Learn](https://learn.microsoft.com/ja-jp/windows/wsl/install)ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚
  - Ubuntu 20.04
    - WSL ã® Linux ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ä¸Šè¨˜ã‚’ä½¿ã£ã¦ã„ã¾ã—ãŸãŒã€è¨¼æ˜æ›¸ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã® OpenSSL 3 ç³»ãŒä½¿ãˆã‚‹ Linux ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚ã‚Œã°ãªã‚“ã§ã‚‚ã‚ˆã„ã§ã™ã€‚

## ä¸»ãªä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- [YetAnotherHttpHandler 1.0.0](https://github.com/Cysharp/YetAnotherHttpHandler)
  - Unity ã§åˆ©ç”¨ã§ãã‚‹ HTTP/2 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ 
- [MagicOnion 6.0.1](https://github.com/Cysharp/MagicOnion)
  - HTTP/2 ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦åˆ©ç”¨ã§ãã‚‹ï¼
- [OpenSSL 3.2.0](https://www.openssl.org/)
  - è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã§ãã‚‹ãƒ„ãƒ¼ãƒ«
  - OpenSSL 3 ç³»ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
  - YetAnotherHttpHandler ã¯ OpenSSL 1 ç³»ã§ç”Ÿæˆã—ãŸè¨¼æ˜æ›¸ã¯ä¿¡é ¼ã—ã¾ã›ã‚“ã€‚


# æ‰‹é †

## MagicOnion Server ã¨ Unity Client ã®æº–å‚™

ä»¥ä¸‹ã«æœ¬è¨˜äº‹ã§ç´¹ä»‹ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ãƒªãƒã‚¸ãƒˆãƒªã‚’ç½®ã„ã¦ãŠãã¾ã™ã€‚è¨˜äº‹ã®èª¬æ˜ãŒä¸ååˆ†ã ã£ãŸã‚Šã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
- MagicOnion Server
  - [tou-tou/magiconion-sample-server ã® https ãƒ–ãƒ©ãƒ³ãƒ](https://github.com/tou-tou/magiconion-sample-server/tree/https)
- Unity Client
  - [tou-tou/magiconion-sample-client ã® https ãƒ–ãƒ©ãƒ³ãƒ](https://github.com/tou-tou/magiconion-sample-client/tree/https)
  
## (å¿…è¦ãªäººã¯) Ubuntu 20.04 ã§ OpenSSL 3 ç³»ã¸æ›´æ–°

OpenSSL 1.1.1 ã§ç”Ÿæˆã—ãŸè¨¼æ˜æ›¸ã ã¨ YetAntherHttpHandler ãŒè¨¼æ˜æ›¸æ¤œè¨¼æ™‚ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãªã„æ—¨ã®ã‚¨ãƒ©ãƒ¼ã‚’å‡ºåŠ›ã—ã¦ã—ã¾ã„ã¾ã™ã€‚ãã®ãŸã‚ã€OpenSSL 3 ç³»ã«æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

:::message
Ubuntu 20.04 ã¯ ã‚µãƒãƒ¼ãƒˆçµ‚äº†ã—ãŸï¼ˆ2023/09/11ï¼‰OpenSSL1.1.1 ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€æœ€æ–°ç‰ˆã«æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
:::

[Ubuntu 20.04 ã§ OpenSSL 3.2.0 ã«æ›´æ–°ã™ã‚‹](https://zenn.dev/toutou/articles/c14d73c458f18d) ã‚’å‚è€ƒã«æ›´æ–°ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã« OpenSSL ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ 3.2.0 ä»¥ä¸Šã§ã‚ã‚Œã° OK ã§ã™ã€‚
```
$  openssl version
OpenSSL 3.2.0 23 Nov 2023 (Library: OpenSSL 3.2.0 23 Nov 2023)
```


## è‡ªå·±ç½²åè¨¼æ˜æ›¸ã®ç”Ÿæˆ

ç§˜å¯†éµ (server.key) ã¨ è¨¼æ˜æ›¸ç™ºè¡Œè¦æ±‚ï¼ˆserver.csrï¼‰ã€è¨¼æ˜æ›¸ (server.crt) ã¨ è¨¼æ˜æ›¸ã¨å¯¾å¿œã™ã‚‹ç§˜å¯†éµã‚’å«ã‚€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ (server.pfx) ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

`.gitignore`ã«å°‘ãªãã¨ã‚‚`*.key`ã¨`*.pfx`ã¯è¿½åŠ ã—ã¦ãŠãã¾ã—ã‚‡ã†


ä¾‹ãˆã°ã€`Ubuntu` ã¸`bash`ã§ãƒ­ã‚°ã‚¤ãƒ³ã—`magiconion-sample-server` ã«ç§»å‹•ã—`Server/certificate`é…ä¸‹ã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãã¨ã—ã¾ã™ã€‚

### ç§˜å¯†éµã®ç”Ÿæˆ
ç§˜å¯†éµã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæµå‡ºã™ã‚‹ã¨ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã€é©åˆ‡ã«ä¿ç®¡ã—ã¾ã—ã‚‡ã†ã€‚

```bash:bash
# path-to magiconion-sample-server
mkdir Server/certificate
cd Server/certificate
openssl genrsa 4096 > server.key
```

### è¨¼æ˜æ›¸ç™ºè¡Œè¦æ±‚ã®ç”Ÿæˆ

è¨¼æ˜æ›¸ç™ºè¡Œè¦æ±‚ï¼ˆCSRï¼‰ã¯ã€èªè¨¼å±€ãŒè¨¼æ˜æ›¸ã‚’ç”Ÿæˆã™ã‚‹ã®ã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã€ã‚µãƒ¼ãƒãƒ¼ãƒ›ã‚¹ãƒˆåã‚„ç§˜å¯†éµï¼ˆserver.keyï¼‰ã«å¯¾å¿œã™ã‚‹å…¬é–‹éµãŒå«ã¾ã‚Œã¾ã™ã€‚

ãƒ›ã‚¹ãƒˆåã¯ä¾‹ãˆã°`dummy.example.com`ã¨ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã€ã“ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚‚ã¨ã« CSR ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
```cnf:myssl.cnf
[ req ]
default_bits       = 4096
default_md         = sha256
prompt             = no
encrypt_key        = no
distinguished_name = dn

[ dn ]
CN=dummy.example.com

[ ext ]
basicConstraints=CA:FALSE
keyUsage=digitalSignature, keyEncipherment
subjectAltName=@alt_names

[ alt_names ]
DNS.1=dummy.example.com
DNS.2=www.dummy.example.com
```


```
openssl req -new -key server.key -out server.csr -config myssl.cnf
```


### è‡ªå·±ç½²åè¨¼æ˜æ›¸ã®ç”Ÿæˆ

ä»Šå›ã¯è‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’ç”Ÿæˆã™ã‚‹ã®ã§ã€èªè¨¼å±€ã®ä»£ã‚ã‚ŠãŒè‡ªèº«ã«ãªã‚Šã¾ã™ã€‚
ãã®ãŸã‚ CSR ç”Ÿæˆã«ä½¿ã£ãŸåŒã˜ç§˜å¯†éµ (server.key) ã§ CSR ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã€CSR ã®æœ«å°¾ã«ãƒãƒƒã‚·ãƒ¥ã‚’è¿½è¨˜ã™ã‚‹ï¼ˆç½²åã™ã‚‹ï¼‰ã“ã¨ã§è‡ªç½²åè¨¼æ˜æ›¸ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

CSR ã‹ã‚‰ç§˜å¯†éµã§ç½²åã—ã¦è¨¼æ˜æ›¸ã‚’ç”Ÿæˆã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚
```bash:bash
openssl x509 -req -in server.csr -signkey server.key -out server.crt -days 7300 -extfile myssl.cnf -extensions ext
```
ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã§`myssl.cnf`ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã®ã¯ã€`ext`ã‚„`alt_names`ã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã§ã™ã€‚
` openssl req -text -noout -verify -in server.csr`ã¨`openssl x509 -in server.crt -text -noout`ã‚’è¦‹æ¯”ã¹ã¦ã¿ã‚‹ã¨é•ã„ãŒåˆ¤ã‚Šã¾ã™ã€‚

### ã‚µãƒ¼ãƒãƒ¼ç”¨ pfx ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ

è¨¼æ˜æ›¸ã¨å¯¾å¿œã™ã‚‹ç§˜å¯†éµã‚’å«ã‚€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ (server.pfx) ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã§ã¯ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚
ç”Ÿæˆæ™‚ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã¡ã‚‰ã‚‚ `server.key`ã¨åŒæ§˜ã«é©åˆ‡ã«ä¿ç®¡ã—ã¾ã—ã‚‡ã†ã€‚

```bash:bash
openssl pkcs12 -export -out server.pfx -inkey server.key -in server.crt
```



### è¨¼æ˜æ›¸ã®ç¢ºèª
è¨¼æ˜æ›¸ã®ä¸­èº«ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash:bash
 openssl x509 -in server.crt -text -noout
 Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            48:9a:ec:0f:5f:af:7d:6a:69:b0:d4:57:1e:a2:41:13:57:fe:62:e9
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=dummy.example.com
        Validity
            Not Before: Jan  8 10:31:28 2024 GMT
            Not After : Jan  7 10:31:28 2025 GMT
        Subject: CN=dummy.example.com
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (4096 bit)
                Modulus:
                    00:9b:16:ad:a6:1f:11:fc:c4:7a:77:46:49:6b:0d:
                    ...(çœç•¥)
                    2d:8d:f9
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Basic Constraints:
                CA:FALSE
            X509v3 Key Usage:
                Digital Signature, Key Encipherment
            X509v3 Subject Alternative Name:
                DNS:dummy.example.com, DNS:www.dummy.example.com
            X509v3 Subject Key Identifier:
                A4:A8:BA:AF:16:C7:00:FE:98:A2:B8:10:9B:B9:77:60:15:2D:5B:3E
    Signature Algorithm: sha256WithRSAEncryption
    Signature Value:
        4e:90:0f:e9:0a:f6:1b:24:72:44:b1:be:07:95:62:e4:2f:b9:
        ...(çœç•¥)
        f7:21:e1:74:e5:e7:b9:9c
 ```

ä»¥ä¸‹ãŒç¢ºèªã§ãã‚Œã° OK ã§ã™ã€‚ã“ã“ã‚‰è¾ºãŒæ¬ ã‘ã¦ã„ã‚‹ã¨ YetAnotherHttpHandler ã§ã®è¨¼æ˜æ›¸æ¤œè¨¼ãŒå¤±æ•—ã—ã¦ã„ã¾ã™ã€‚

 - `Version: 3`ã§ã‚ã‚‹
 - è‡ªå·±ç½²åè¨¼æ˜æ›¸ãªã®ã§ã€`Issuer`ã¨`Subject`ãŒä¸€è‡´ã—ã¦ã„ã‚‹
 - `CA:FALSE`ã¨ãªã£ã¦ãŠã‚Šã€èªè¨¼å±€ã§ã¯ãªãã‚µãƒ¼ãƒãƒ¼ç”¨ã®è¨¼æ˜æ›¸ã‚’ç¤ºã—ã¦ã„ã‚‹
 - Subject Alternative Name (SAN) ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
   - YetAnotherHttpHandler ã¯ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã™ã‚‹ FQDN ã¨ SAN ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã‚’æ¤œè¨¼ã—ã¦ã„ã‚‹ã£ã½ã„

### Windows ã®ãƒ›ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†
Windowsãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ `dummy.example.com`ã®ãƒ›ã‚¹ãƒˆåã§è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ãŸã®ã§ã€ãã®ãƒ›ã‚¹ãƒˆåã¨ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ã—ã¾ã™ã€‚
`hosts`ãƒ•ã‚¡ã‚¤ãƒ«ã§æŒ‡å®šã—ãŸãƒãƒƒãƒ”ãƒ³ã‚°ã¯ DNS ã‚µãƒ¼ãƒãƒ¼ã«ã‚ˆã‚‹ãƒ›ã‚¹ãƒˆåã®è§£æ±ºã‚ˆã‚Šã‚‚å„ªå…ˆã•ã‚Œã¾ã™ã€‚

`C:\Windows\System32\drivers\etc\hosts`ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ãƒ¢å¸³ãªã©ã§ç®¡ç†è€…æ¨©é™ã§é–‹ãã€ä»¥ä¸‹ã®è¡Œã‚’è¿½è¨˜ã—ã¾ã™ã€‚

`127.0.0.1 dummy.example.com`

ã“ã‚Œã«ã‚ˆã£ã¦ã€`dummy.example.com`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã™ã‚‹ã¨`127.0.0.1`ã«æ¥ç¶šã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚


# ã‚µãƒ¼ãƒãƒ¼ã® https è¨­å®š

2é€šã‚Šã‚ã‚Šã¾ã™ã€‚ä¸€ã¤ã¯ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ã«è‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã‚‹`appsettings.json`ã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•ã§ã™ã€‚ã‚‚ã†ä¸€ã¤ã¯ä¸€ã¤ã¯ã‚³ãƒ¼ãƒ‰ä¸Šï¼ˆ `Program.cs`ï¼‰ã«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨˜è¿°ã™ã‚‹æ–¹æ³•ã§ã™ã€‚

å‚è€ƒ : [Kestrel web server in ASP.NET Core | Microsoft Learn](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel?view=aspnetcore-8.0)


## æ–¹æ³•ï¼‘ï¼šappsettings.json ã§ https ã®è¨­å®š

ä»¥ä¸‹ã‚’ Server ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç½®ãã¾ã™ã€‚
```json:appsettings.json
{
  "Kestrel": {
    "Endpoints": {
      "Grpc": {
        "Url": "http://dummy.example.com:5000",
        "Protocols": "Http2"
      },
      "Https": {
        "Url": "https://dummy.example.com:5001",
        "Protocols": "Http1AndHttp2"
      },
      "Http": {
        "Url": "http://dummy.example.com:5002",
        "Protocols": "Http1"
      }
    },
    "Certificates": {
      "Default": {
        "Path": "./certificate/server.pfx",
        "Password": "password"
      }
    }
  }
}
```

https://github.com/tou-tou/magiconion-sample-server/blob/e007c6bb770fc46711378b07c1b5b6ff142b0008/Server/appsettings.json

## æ–¹æ³•2ï¼šã‚³ãƒ¼ãƒ‰ä¸Šã§ã® https ã®è¨­å®š

ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¾ã™ã€‚

```cs:Program.cs
~~~
builder.WebHost.ConfigureKestrel(options =>
{
    // HTTP/2 Only ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆnot HTTPSï¼‰
    options.Listen(IPAddress.Parse("0.0.0.0"), 5000,
        listenOptions => { listenOptions.Protocols = HttpProtocols.Http2; });

    // HTTP/2 ,HTTPS ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è¨­å®š
    options.Listen(IPAddress.Parse("0.0.0.0"), 5001, listenOptions =>
    {
        // --load-cert=true ãŒæŒ‡å®šã•ã‚Œã¦ã„ãŸã‚‰è¨¼æ˜æ›¸ã‚’èª­ã¿è¾¼ã‚€
        if (args.Any(arg => arg == "--load-cert=true"))
        {
            Console.WriteLine("load certificate");
            listenOptions.UseHttps(new X509Certificate2("certificate/server.pfx", "password"));
            listenOptions.Protocols = HttpProtocols.Http1AndHttp2;
        }
    });

    // ç–é€šç¢ºèªç”¨ã®HTTP 1.1ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è¨­å®š
    options.Listen(IPAddress.Parse("0.0.0.0"), 5002,
        listenOptions => { listenOptions.Protocols = HttpProtocols.Http1; });
});
~~~

```

https://github.com/tou-tou/magiconion-sample-server/blob/e007c6bb770fc46711378b07c1b5b6ff142b0008/Server/Program.cs


ä¸Šè¨˜ã® `0.0.0.0`ã¯`127.0.0.1`ã§ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚

## ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š
ç¶šã„ã¦`appsettings.json`ã‚„`server.pfx`ã‚’ã‚µãƒ¼ãƒãƒ¼å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ã™ã‚‹è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚

```csproj:Server.csproj
    <ItemGroup>
        <None Update="appsettings.json">
            <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        </None>
        <!-- FOR SSL/TLS SUPPORT -->
        <None Update="certificate/server.pfx">
            <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        </None>
    </ItemGroup>
```

https://github.com/tou-tou/magiconion-sample-server/blob/e007c6bb770fc46711378b07c1b5b6ff142b0008/Server/Server.csproj

ã“ã‚Œã§ã‚µãƒ¼ãƒãƒ¼å´ã®è¨­å®šã¯çµ‚äº†ã§ã™ã€‚
# Unity Client ã®è¨­å®š

## è¨¼æ˜æ›¸ã®é…ç½®

Unity Editor ã‚’é–‹ãã€Projects ã‚¿ãƒ–ã‹ã‚‰`Assets/StreamingAssets`ã‚’ä½œæˆã—ã€ `certificate/server.crt` ã‚’ç½®ãã¾ã™ã€‚


## handler ã§ã®è¨¼æ˜æ›¸ã®æŒ‡å®š

YetAnotherHttpHandler ã® `RootCertificates` ã«ç”Ÿæˆã—ãŸè‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’æŒ‡å®šã—ã¾ã™ã€‚


```cs:Initializer.cs
~~~
[RuntimeInitializeOnLoadMethod(RuntimeInitializeLoadType.BeforeSceneLoad)]
        public static void OnRuntimeInitialize()
        {
            GrpcChannelProviderHost.Initialize(
                new GrpcNetClientGrpcChannelProvider(() => new GrpcChannelOptions()
                {
                    HttpHandler = new Cysharp.Net.Http.YetAnotherHttpHandler()
                    {
                        //Http2Only = true,
                        RootCertificates =
                            File.ReadAllText(Path.Combine(Application.streamingAssetsPath, "certificate/server.crt")),
                        SkipCertificateVerification = false
                    }
                }));
        }
~~~
```

æ¥ç¶šå…ˆã¨ã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼ã§è¨­å®šã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```cs:Program.cs
~~~
 _channel = GrpcChannelx.ForAddress("https://dummy.example.com:5001/");
~~~
```


ã¾ãŸã€http2 only (not https) ã§æ¥ç¶šã—ãŸã„å ´åˆã¯ã€`Http2Only`ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã—ã€`RootCertificate`ã€`SkipCertificateVerification`ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚ã“ã®å ´åˆã€æ¥ç¶šå…ˆã¯`http://dummy.example.com:5000/`ã«ãªã‚Šã¾ã™ã€‚

# å‹•ã‹ã™
Serverã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¾ã™ã€‚IDEã‹ã‚‰èµ·å‹•ã™ã‚‹ãªã‚Šãƒ“ãƒ«ãƒ‰å¾Œã®å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’èµ·å‹•ã™ã‚‹ãªã‚Šã—ã¦ãã ã•ã„ã€‚
https ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã‚³ãƒ¼ãƒ‰ä¸Šã«å®šç¾©ã—ãŸå ´åˆã¯ã€`--load-cert=true`ã‚’å¼•æ•°ã«æŒ‡å®šã—ã¦å®Ÿè¡Œã—ã¾ã™ã€‚

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚‚ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‹ã‚‰å®Ÿè¡Œã™ã‚‹ãªã‚Šã€ãƒ“ãƒ«ãƒ‰å¾Œã®å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’èµ·å‹•ã™ã‚‹ãªã‚Šã—ã¦ãã ã•ã„ã€‚

Unity ã§ IL2CPPãƒ“ãƒ«ãƒ‰ã‚’ã™ã‚‹å ´åˆã¯ä»¥ä¸‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚
https://zenn.dev/toutou/articles/7918da3d1a9e1d#il2cpp-%E3%83%93%E3%83%AB%E3%83%89%E3%81%AE%E8%A8%AD%E5%AE%9A


# ãŠã‚ã‚Šã«

å®‰å…¨ãªé€šä¿¡ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦å¬‰ã—ã„ï¼


éœ€è¦ãŒã‚ã‚Šãã†ãªã‚‰ MagicOnion ãƒã‚¿ã§ã‚‚ã†ã—ã°ã‚‰ãè¨˜äº‹ã‚’æ›¸ã„ã¦ã„ã‘ãŸã‚‰ã„ã„ãªãï½ã¨æ€ã„ã¾ã™ã€‚

- [MagicOnion + MessagePack + YetAnotherHttpHandler ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ã‚’è¡Œã†](https://zenn.dev/toutou/articles/7918da3d1a9e1d)
- Unity(YetAnotherHttpHandler)ã¨MagicOnionã§è‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’ä½¿ã£ãŸHTTPS&HTTP/2é€šä¿¡ï¼ˆæœ¬è¨˜äº‹ï¼‰
- MagicOnion Server ã‚³ãƒ³ãƒ†ãƒŠã‚’ GCP ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
- DFrame ã§ MagicOnion Server ã®è² è·è©¦é¨“
- TLS çµ‚ç«¯ç”¨ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·è¿½åŠ ã«ã‚ˆã‚‹ã‚µãƒ¼ãƒãƒ¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å·®

# å‚è€ƒ
- [Configure SSL/TLS | MagicOnion](https://cysharp.github.io/MagicOnion/articles/deployment/https.html#tls-on-localhost)
- [ã€å›³è§£ã€‘ã‚ˆãåˆ†ã‹ã‚‹ãƒ‡ã‚¸ã‚¿ãƒ«è¨¼æ˜æ›¸(SSLè¨¼æ˜æ›¸)ã®ä»•çµ„ã¿ ã€œhttpsé€šä¿¡ãƒ•ãƒ­ãƒ¼,ç™ºè¡Œæ‰‹é †,CSR,è‡ªå·±ç½²å(ã‚ªãƒ¬ã‚ªãƒ¬)è¨¼æ˜æ›¸,ãƒ«ãƒ¼ãƒˆè¨¼æ˜æ›¸,ä¸­é–“è¨¼æ˜æ›¸ã®å¿…è¦æ€§ã‚„æ‰±ã„ã«ã¤ã„ã¦ã€œ | SEã®é“æ¨™](https://milestone-of-se.nesuke.com/sv-advanced/digicert/digital-certification-summary/)
