---
title: "MagicOnion Server ã‚’ GCP ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹"
emoji: "ğŸ•Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["MagicOnion","GCP"]
published: false
---

# æ¦‚è¦
MagicOnion ã‚’ GCP ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™

ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ GCP Deployment Manager ã‚’ä½¿ã„ã¾ã™ã€‚


# GCP ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
[gcloud CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ Â |Â  Google Cloud CLI ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/sdk/docs/install?hl=ja)

[gcloud CLI ã®åˆæœŸåŒ– Â |Â  Google Cloud CLI ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/sdk/docs/initializing?hl=ja#whats_next)

ã¾ãšã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚Šã¾ã™


```bash:gcloud-cli
> gcloud init
C:\Users\toutou\AppData\Local\Google\Cloud SDK>gcloud init
Welcome! This command will take you through the configuration of gcloud.

Pick configuration to use:


Choose the account you would like to use to perform operations for this configuration:


Pick cloud project to use:
 [1] eternal-courage-411314
 [2] magiconion-sample
 [3] Enter a project ID
 [4] Create a new project
Please enter numeric choice or text value (must exactly match list item):  2

Your current project has been set to: [magiconion-sample].

Do you want to configure a default Compute Region and Zone? (Y/n)?  Y

 [32] asia-northeast1-b
 [33] asia-northeast1-c
 [34] asia-northeast1-a
 [35] asia-south1-c
 [36] asia-south1-b
Did not print [69] options.
Too many options [119]. Enter "list" at prompt to print choices fully.
Please enter numeric choice or text value (must exactly match list item):  34


```

[GCPã‚’ä½¿ã£ã¦HTTPSã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚’å…¬é–‹ã™ã‚‹ï¼ˆå‰ç·¨ï¼‰](https://zenn.dev/knockknock/articles/10aa24fde47c45)

## æœ‰åŠ¹ã«ã™ã‚‹ API
- [Compute Engine API â€“ ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ â€“ magiconion-sample â€“ Google Cloud ã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://console.cloud.google.com/marketplace/product/google/compute.googleapis.com)
- Cloud Build
- Artifact Registry
- Deployment Manager
- 

## gcloud sdk ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
[gcloud CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ Â |Â  Google Cloud CLI ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/sdk/docs/install?hl=ja#supported_python_versions)

## API ã®æœ‰åŠ¹ã‹

ä»¥ä¸‹ã‚’ç¢ºèª
```bash
>gcloud config get project
magiconion-sample
```

æœ‰åŠ¹ã‹
```bash
gcloud services enable compute.googleapis.com artifactregistry.googleapis.com cloudbuild.googleapis.com deploymentmanager.googleapis.com
```
## ãƒªãƒã‚¸ãƒˆãƒªã®ä½œæˆ
[æ¨™æº–ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã™ã‚‹ Â |Â  Artifact Registry ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ Â |Â  Google Cloud](https://cloud.google.com/artifact-registry/docs/repositories/create-repos?hl=ja#create-gcloud)

```
gcloud artifacts repositories create onion-server --repository-format=docker --location=asia-northeast1 --async
```

# Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰

### Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥

ã¯ã˜ã‚ã¦ã®å ´åˆã¯
[ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ: Docker Hub ãƒªãƒ¢ãƒ¼ãƒˆ ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã™ã‚‹ Â |Â  Artifact Registry ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ Â |Â  Google Cloud](https://cloud.google.com/artifact-registry/docs/repositories/create-dockerhub-remote-repository?hl=ja)

```
gcloud auth login
>gcloud auth configure-docker asia-northeast1-docker.pkg.dev
```

```bash
docker build -t asia-northeast1-docker.pkg.dev/magiconion-sample/onion-server/onion-server:latest -f Dockerfile .  

docker push asia-northeast1-docker.pkg.dev/magiconion-sample/onion-server/onion-server:latest 


docker push asia-northeast1-docker.pkg.dev/magiconion-sample/onion-server/onion-server:latest

```

![Alt text](/images/gcp/2024-01-16_21h25_16.png)


# ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤

gcloud deployment-manager deployments create onisync-deploy --config deploy.yaml

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤
```
gcloud compute instances create onion-instance --source-instance-template instance-template --zone asia-northeast1-a
```

å‰Šé™¤
```
gcloud compute instances delete onion-instance --zone asia-northeast1-a
```


# æ¥ç¶šã®ç¢ºèª


# https æ¥ç¶š

# memo
- GCE ä¸Šã§ã‚µãƒ¼ãƒãƒ¼å®Ÿè¡Œæ™‚ã€ãƒ›ã‚¹ãƒˆã¨ã‚³ãƒ³ãƒ†ãƒŠä¸Šã§ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹å¿…è¦ãŒãªã•ãã†....ãªãœï¼Ÿ
### ã“ã®è¨˜äº‹ã§ã®ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆã¯
- local ã§ docker build -> ArtifactRegistry
- ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ deployment manager ã§ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
- ip å›ºå®š
- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•


## docker ã‚³ãƒ³ãƒ†ãƒŠã®ã‚ãƒ¼ã‹ã‚‹ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
### Dockerfileã®ãƒ“ãƒ«ãƒ‰
docker build -t onisync:0.01 -f OniSync.Server/Dockerfile .

### Dcokerã‚³ãƒ³ãƒ†ãƒŠã®å®Ÿè¡Œ
docker run -p 5000:5000 -p 5002:5002 onisync:0.01 dev


```bash
gcloud compute instances create-with-container instance-test --project=fuuro-409604 --zone=us-central1-a --machine-type=n1-standard-1 --service-account=840485945008-compute@developer.gserviceaccount.com --container-image=asia-northeast1-docker.pkg.dev/fuuro-409604/onisync/onisync:0.01

```


### ç†æƒ³ã¯
- PR
- cloud build
  - <- secret manager (pfx file)
  - -> artifact registry
- deploymentmanager
- deploy instance, instance group, network, load balancer,  

# å‚è€ƒ
- [ã‚µãƒ¼ãƒåãŒIPã‚¢ãƒ‰ãƒ¬ã‚¹ã®å ´åˆã®è¨¼æ˜æ›¸ä½œæˆ / ã‚µãƒ–ã‚¸ã‚§ã‚¯ãƒˆä»£æ›¿å (SAN) ã®è¨­å®šæ–¹æ³• | æ™´è€•é›¨èª­](https://tex2e.github.io/blog/protocol/certificate-with-ip-addr)
- [MagicOnionã‹ã‚‰å§‹ã‚ã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ (å‰ç·¨) #Unity - Qiita](https://qiita.com/naoya-kishimoto/items/0d913a4b65ec0c4088a6)
- [MagicOnionã‹ã‚‰å§‹ã‚ã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ (å¾Œç·¨) #Unity - Qiita](https://qiita.com/naoya-kishimoto/items/8a9a5db30717865d867e#%E5%85%A8%E4%BD%93%E6%A7%8B%E6%88%90%E5%9B%B3)
- [[CEDEC 2021] é‹ç”¨ä¸­ã‚¿ã‚¤ãƒˆãƒ«ã§ã‚‚æ€–ããªã„ï¼ ã€ãƒ¡ãƒ«ã‚¯ã‚¹ãƒˆãƒ¼ãƒªã‚¢ã€ã«ãŠã‘ã‚‹ãƒã‚¤ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ãƒ­ãƒ¼ã‚³ã‚¹ãƒˆãªãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡æŠ€è¡“ã®å°å…¥äº‹ä¾‹ | PPT](https://www.slideshare.net/NaoyaKishimoto/cedec-2021)
